function getNodesCenter(t){var e=0,n=0;t.forEach(function(t){e+=t.cx,n+=t.cy});var o={x:e/t.length,y:n/t.length};return o}function circleLayoutNodes(t,e){null==e&&(e={});var n=e.cx,o=e.cy,i=e.minRadius,r=e.nodeDiameter,a=e.hScale||1,l=e.vScale||1;if(e.beginAngle||0,e.endAngle||2*Math.PI,null==n||null==o){var u=getNodesCenter(t);n=u.x,o=u.y}var h=0,c=[],s=[];t.forEach(function(t){null==e.nodeDiameter?(t.diameter&&(r=t.diameter),r=t.radius?2*t.radius:Math.sqrt(2*t.width*t.height),s.push(r)):s.push(r),h+=r}),t.forEach(function(t,e){var n=s[e]/h;c.push(Math.PI*n)});var d=(t.length,c[0]+c[1]),f=s[0]/2+s[1]/2,g=f/2/Math.sin(d/2);null!=i&&i>g&&(g=i);var y=g*a,v=g*l,x=e.animate,p=0;return x?!function(){var e=x.time||1e3;t.forEach(function(t,i){p+=0==i?c[i]:c[i-1]+c[i];var r=n+Math.cos(p)*y,a=o+Math.sin(p)*v;Animate.stepByStep(t,{x:r-t.width/2,y:a-t.height/2},e).start()})}():t.forEach(function(t,e){p+=0==e?c[e]:c[e-1]+c[e];var i=n+Math.cos(p)*y,r=o+Math.sin(p)*v;t.cx=i,t.cy=r}),{cx:n,cy:o,radius:y,radiusA:y,radiusB:v}}function GridLayout(t,e){return function(n){var o=n.childs;if(!(o.length<=0))for(var i=n.getBound(),r=o[0],a=(i.width-r.width)/e,l=(i.height-r.height)/t,u=0,h=0;h<t;h++)for(var c=0;c<e;c++){var s=o[u++],d=i.left+a/2+c*a,f=i.top+l/2+h*l;if(s.setLocation(d,f),u>=o.length)return}}}function FlowLayout(t,e){return null==t&&(t=0),null==e&&(e=0),function(n){var o=n.childs;if(!(o.length<=0))for(var i=n.getBound(),r=i.left,a=i.top,l=0;l<o.length;l++){var u=o[l];r+u.width>=i.right&&(r=i.left,a+=e+u.height),u.setLocation(r,a),r+=t+u.width}}}function AutoBoundLayout(){return function(t,e){if(e.length>0){for(var n=1e7,o=-1e7,i=1e7,r=-1e7,a=o-n,l=r-i,u=0;u<e.length;u++){var h=e[u];h.x<=n&&(n=h.x),h.x>=o&&(o=h.x),h.y<=i&&(i=h.y),h.y>=r&&(r=h.y),a=o-n+h.width,l=r-i+h.height}t.x=n,t.y=i,t.width=a,t.height=l}}}function getRootNodes(t){var e=[],n=t.filter(function(t){return t instanceof Link||(e.push(t),!1)});return t=e.filter(function(t){for(var e=0;e<n.length;e++)if(n[e].nodeZ===t)return!1;return!0}),t=t.filter(function(t){for(var e=0;e<n.length;e++)if(n[e].nodeA===t)return!0;return!1})}function calcSize(t){var e=0,n=0;return t.forEach(function(t){e+=t.width,n+=t.height}),{width:e/t.length,height:n/t.length}}function calcAndSetPosition(t,e,n,o){e.x+=n,e.y+=o;for(var i=getNodeChilds(t,e),r=0;r<i.length;r++)calcAndSetPosition(t,i[r],n,o)}function getTreeNodes(t,e){function n(e,i){var r=getNodeChilds(t,e);null==o[i]&&(o[i]={},o[i].nodes=[],o[i].childs=[]),o[i].nodes.push(e),o[i].childs.push(r);for(var a=0;a<r.length;a++)n(r[a],i+1),r[a].parent=e}var o=[];return n(e,0),o}function TreeLayout(t,e,n){return function(o){function i(i,r){for(var a=getTreeDeep(i,r),l=getTreeNodes(i,r),u=l[""+a].nodes,h=0;h<u.length;h++){var c=u[h],s=(h+1)*(e+10),d=a*n;"down"==t||("up"==t?d=-d:"left"==t?(s=-a*n,d=(h+1)*(e+10)):"right"==t&&(s=a*n,d=(h+1)*(e+10))),c.setLocation(s,d)}for(var f=a-1;f>=0;f--)for(var g=l[""+f].nodes,y=l[""+f].childs,v=0;v<g.length;v++){var x=g[v],p=y[v];if("down"==t?x.y=f*n:"up"==t?x.y=-f*n:"left"==t?x.x=-f*n:"right"==t&&(x.x=f*n),p.length>0?"down"==t||"up"==t?x.x=(p[0].x+p[p.length-1].x)/2:("left"==t||"right"==t)&&(x.y=(p[0].y+p[p.length-1].y)/2):v>0&&("down"==t||"up"==t?x.x=g[v-1].x+g[v-1].width+e:("left"==t||"right"==t)&&(x.y=g[v-1].y+g[v-1].height+e)),v>0)if("down"==t||"up"==t){if(x.x<g[v-1].x+g[v-1].width)for(var L=g[v-1].x+g[v-1].width+e,N=Math.abs(L-x.x),w=v;w<g.length;w++)calcAndSetPosition(o.childs,g[w],N,0)}else if(("left"==t||"right"==t)&&x.y<g[v-1].y+g[v-1].height)for(var C=g[v-1].y+g[v-1].height+e,m=Math.abs(C-x.y),P=v;P<g.length;P++)calcAndSetPosition(o.childs,g[P],0,m)}}var r=null;null==e&&(r=calcSize(o.childs),e=r.width,("left"==t||"right"==t)&&(e=r.width+10)),null==n&&(null==r&&(r=calcSize(o.childs)),n=2*r.height),null==t&&(t="down");var a=getRootNodes(o.childs);a.length>0&&!function(){i(o.childs,a[0]);var t=Util.getElementsBound(o.childs),e=o.getCenterLocation(),n=e.x-(t.left+t.right)/2,r=e.y-(t.top+t.bottom)/2;o.childs.forEach(function(t){t instanceof Node&&(t.x+=n,t.y+=r)})}()}}function CircleLayout(t){return function(e){function n(e,o,i){var r=getNodeChilds(e,o);0!=r.length&&!function(){null==i&&(i=t);var a=2*Math.PI/r.length;r.forEach(function(t,r){var l=o.x+i*Math.cos(a*r),u=o.y+i*Math.sin(a*r);t.setLocation(l,u);var h=i/2;n(e,t,h)})}()}var o=getRootNodes(e.childs);o.length>0&&!function(){n(e.childs,o[0]);var t=Util.getElementsBound(e.childs),i=e.getCenterLocation(),r=i.x-(t.left+t.right)/2,a=i.y-(t.top+t.bottom)/2;e.childs.forEach(function(t){t instanceof Node&&(t.x+=r,t.y+=a)})}()}}function getGridPositions(t,e,n,o,i,r){for(var a=[],l=0;l<n;l++)for(var u=0;u<o;u++)a.push({x:t+u*i,y:e+l*r});return a}function getCyclePositions(t,e,n,o,i,r){var a=i?i:0,l=r?r:2*Math.PI,u=l-a,h=u/n,c=[];a+=h/2;for(var s=a;l>=s;s+=h){var d=t+Math.cos(s)*o,f=e+Math.sin(s)*o;c.push({x:d,y:f})}return c}function getTreePositions(t,e,n,o,i,r){var a=r||"bottom",l=[];if("bottom"==a)for(var u=t-n/2*o+o/2,h=0;h<=n;h++)l.push({x:u+h*o,y:e+i});else if("top"==a)for(var c=t-n/2*o+o/2,s=0;s<=n;s++)l.push({x:c+s*o,y:e-i});else if("right"==a)for(var d=e-n/2*o+o/2,f=0;f<=n;f++)l.push({x:t+i,y:d+f*o});else if("left"==a)for(var g=e-n/2*o+o/2,y=0;y<=n;y++)l.push({x:t-i,y:g+y*o});return l}function adjustPosition(t,e){if(t.layout){var n=t.layout,o=n.type,i=null;if("circle"==o){var r=n.radius||Math.max(t.width,t.height);i=getCyclePositions(t.cx,t.cy,e.length,r,t.layout.beginAngle,t.layout.endAngle)}else if("tree"==o){var a=n.width||50,l=n.height||50,u=n.direction;i=getTreePositions(t.cx,t.cy,e.length,a,l,u)}else{if("grid"!=o)return;i=getGridPositions(t.x,t.y,n.rows,n.cols,n.horizontal||0,n.vertical||0)}for(var h=0;h<e.length;h++)e[h].setCenterLocation(i[h].x,i[h].y)}}function getNodeChilds(t,e){for(var n=[],o=0;o<t.length;o++)t[o]instanceof Link&&t[o].nodeA===e&&n.push(t[o].nodeZ);return n}function layoutNode(t,e,n){var o=getNodeChilds(t.childs,e);if(0===o.length)return null;if(adjustPosition(e,o),!0===n)for(var i=0;i<o.length;i++)layoutNode(t,o[i],n);return null}function springLayout(t,e){function n(t,e){var n=t.x-e.x,o=t.y-e.y;l+=n*i,u+=o*i,l*=r,u*=r,u+=a,e.x+=l,e.y+=u}function o(){if(!(++h>150)){for(var e=0;e<c.length;e++)c[e]!=t&&n(t,c[e],c);setTimeout(o,1e3/24)}}var i=.01,r=.95,a=-5,l=0,u=0,h=0,c=e.getElementsByClass(Node);o()}function getTreeDeep(t,e){function n(t,e,i){var r=getNodeChilds(t,e);i>o&&(o=i);for(var a=0;a<r.length;a++)n(t,r[a],i+1)}var o=0;return n(t,e,0),o}var _l=require("./_link"),_n=require("./_node"),Util=require("./_util"),Animate=require("./_animate"),Link=_l.Link,Node=_n.Node;module.exports={layoutNode:layoutNode,getNodeChilds:getNodeChilds,adjustPosition:adjustPosition,springLayout:springLayout,getTreeDeep:getTreeDeep,getRootNodes:getRootNodes,GridLayout:GridLayout,FlowLayout:FlowLayout,AutoBoundLayout:AutoBoundLayout,CircleLayout:CircleLayout,TreeLayout:TreeLayout,getNodesCenter:getNodesCenter,circleLayoutNodes:circleLayoutNodes};