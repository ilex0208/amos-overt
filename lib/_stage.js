function createEagleEye(t){return{hgap:16,visible:!1,exportCanvas:document.createElement("canvas"),getImage:function(e,i){var s=t.getBound(),n=1,a=1;this.exportCanvas.width=t.canvas.width,this.exportCanvas.height=t.canvas.height,null!=e&&null!=i?(this.exportCanvas.width=e,this.exportCanvas.height=i,n=e/s.width,a=i/s.height):(s.width>t.canvas.width&&(this.exportCanvas.width=s.width),s.height>t.canvas.height&&(this.exportCanvas.height=s.heigh));var h=this.exportCanvas.getContext("2d");return t.childs.length>0&&(h.save(),h.clearRect(0,0,this.exportCanvas.width,this.exportCanvas.height),t.childs.forEach(function(e){1==t.visible&&(t.save(),t.translateX=0,t.translateY=0,t.scaleX=1,t.scaleY=1,h.scale(n,a),s.left<0&&(t.translateX=Math.abs(s.left)),s.top<0&&(t.translateY=Math.abs(s.top)),t.paintAll=!0,t.repaint(h),t.paintAll=!1,t.restore())}),h.restore()),this.exportCanvas.toDataURL("image/png")},canvas:document.createElement("canvas"),update:function(){this.eagleImageDatas=this.getData(t)},setSize:function(t,e){this.width=this.canvas.width=t,this.height=this.canvas.height=e},getData:function(e,i){function s(t){var e=t.stage.canvas.width,i=t.stage.canvas.height,s=e/t.scaleX/2,n=i/t.scaleY/2;return{translateX:t.translateX+s-s*t.scaleX,translateY:t.translateY+n-n*t.scaleY}}var n=this.canvas.getContext("2d"),a=void 0,h=void 0;if(t.childs.length>0){n.save(),n.clearRect(0,0,this.canvas.width,this.canvas.height),t.childs.forEach(function(t){!0===t.visible&&(t.save(),t.centerAndZoom(null,null,n),t.repaint(n),t.restore())});var o=s(t.childs[0]),c=o.translateX*(this.canvas.width/t.canvas.width)*t.childs[0].scaleX,r=o.translateY*(this.canvas.height/t.canvas.height)*t.childs[0].scaleY,l=t.getBound();a=t.canvas.width/t.childs[0].scaleX/l.width,h=t.canvas.height/t.childs[0].scaleY/l.height,a>1&&(a=1),h>1&&(a=1),c*=a,r*=h,l.left<0&&(c-=Math.abs(l.left)*(this.width/l.width)),l.top<0&&(r-=Math.abs(l.top)*(this.height/l.height)),n.save(),n.lineWidth=1,n.strokeStyle="rgba(255,0,0,1)",n.strokeRect(-c,-r,n.canvas.width*a,n.canvas.height*h),n.restore();var u=null;try{u=n.getImageData(0,0,n.canvas.width,n.canvas.height)}catch(t){console.log(t)}return u}return null!=a&&null!=h?this.setSize(e,i):this.setSize(200,160),null},paint:function(){if(null!=this.eagleImageDatas){var e=t.graphics;e.save(),e.fillStyle="rgba(211,211,211,0.3)",e.fillRect(t.canvas.width-this.canvas.width-2*this.hgap,t.canvas.height-this.canvas.height-1,t.canvas.width-this.canvas.width,this.canvas.height+1),e.fill(),e.save(),e.lineWidth=1,e.strokeStyle="rgba(0,0,0,1)",e.rect(t.canvas.width-this.canvas.width-2*this.hgap,t.canvas.height-this.canvas.height-1,t.canvas.width-this.canvas.width,this.canvas.height+1),e.stroke(),e.restore(),e.putImageData(this.eagleImageDatas,t.canvas.width-this.canvas.width-this.hgap,t.canvas.height-this.canvas.height),e.restore()}else this.eagleImageDatas=this.getData(t)},eventHandler:function(t,e,i){var s=e.x,n=e.y;if(s>i.canvas.width-this.canvas.width&&n>i.canvas.height-this.canvas.height){if(s=e.x-this.canvas.width,n=e.y-this.canvas.height,"mousedown"==t&&(this.lastTranslateX=i.childs[0].translateX,this.lastTranslateY=i.childs[0].translateY),"mousedrag"==t&&i.childs.length>0){var a=e.dx,h=e.dy,o=i.getBound(),c=this.canvas.width/i.childs[0].scaleX/o.width,r=this.canvas.height/i.childs[0].scaleY/o.height;i.childs[0].translateX=this.lastTranslateX-a/c,i.childs[0].translateY=this.lastTranslateY-h/r}}else console.log("other")}}}function Stage(t){function e(t){var e=Util.getEventPosition(t),i=Util.getOffsetPosition(u.canvas);return e.offsetLeft=e.pageX-i.left,e.offsetTop=e.pageY-i.top,e.x=e.offsetLeft,e.y=e.offsetTop,e.target=null,e}function i(t){document.onselectstart=function(){return!1},this.mouseOver=!0;var i=e(t);u.dispatchEventToScenes("mouseover",i),u.dispatchEvent("mouseover",i)}function s(t){v=setTimeout(function(){d=!0},500),document.onselectstart=function(){return!0};var i=e(t);u.dispatchEventToScenes("mouseout",i),u.dispatchEvent("mouseout",i),u.needRepaint=0!=u.animate}function n(t){var i=e(t);u.mouseDown=!0,u.mouseDownX=i.x,u.mouseDownY=i.y,u.dispatchEventToScenes("mousedown",i),u.dispatchEvent("mousedown",i)}function a(t){var i=e(t);u.dispatchEventToScenes("mouseup",i),u.dispatchEvent("mouseup",i),u.mouseDown=!1,u.needRepaint=0!=u.animate}function h(t){v&&(window.clearTimeout(v),v=null),d=!1;var i=e(t);u.mouseDown?0==t.button&&(i.dx=i.x-u.mouseDownX,i.dy=i.y-u.mouseDownY,u.dispatchEventToScenes("mousedrag",i),u.dispatchEvent("mousedrag",i),1==u.eagleEye.visible&&u.eagleEye.update()):(u.dispatchEventToScenes("mousemove",i),u.dispatchEvent("mousemove",i))}function o(t){var i=e(t);u.dispatchEventToScenes("click",i),u.dispatchEvent("click",i)}function c(t){var i=e(t);u.dispatchEventToScenes("dbclick",i),u.dispatchEvent("dbclick",i)}function r(t){var i=e(t);u.dispatchEventToScenes("mousewheel",i),u.dispatchEvent("mousewheel",i),null!=u.wheelZoom&&(t.preventDefault?t.preventDefault():(t=t||window.event,t.returnValue=!1),1==u.eagleEye.visible&&u.eagleEye.update())}function l(t){Util.isIE||!window.addEventListener?(t.onmouseout=s,t.onmouseover=i,t.onmousedown=n,t.onmouseup=a,t.onmousemove=h,t.onclick=o,t.ondblclick=c,t.onmousewheel=r,t.touchstart=n,t.touchmove=h,t.touchend=a):(t.addEventListener("mouseout",s),t.addEventListener("mouseover",i),t.addEventListener("mousedown",n),t.addEventListener("mouseup",a),t.addEventListener("mousemove",h),t.addEventListener("click",o),t.addEventListener("dblclick",c),Util.isFirefox?t.addEventListener("DOMMouseScroll",r):t.addEventListener("mousewheel",r)),window.addEventListener&&window.addEventListener("keydown",function(t){u.dispatchEventToScenes("keydown",Util.cloneEvent(t));var e=t.keyCode;37!=e&&38!=e&&39!=e&&40!=e||(t.preventDefault?t.preventDefault():(t=t||window.event,t.returnValue=!1))},!0)}Tobj.stage=this;var u=this,d=!0,v=null;this.initialize=function(t){l(t),this.canvas=t,this.graphics=t.getContext("2d"),this.childs=[],this.frames=24,this.messageBus=new Util.MessageBus,this.eagleEye=createEagleEye(this),this.wheelZoom=null,this.mouseDownX=0,this.mouseDownY=0,this.mouseDown=!1,this.mouseOver=!1,this.needRepaint=!0,this.serializedProperties=["frames","wheelZoom"]},null!=t&&this.initialize(t),document.oncontextmenu=function(){return d},this.dispatchEventToScenes=function(t,e){if(0!=this.frames&&(this.needRepaint=!0),1==this.eagleEye.visible&&-1!=t.indexOf("mouse")){var i=e.x,s=e.y;if(i>this.width-this.eagleEye.width&&s>this.height-this.eagleEye.height)return void this.eagleEye.eventHandler(t,e,this)}this.childs.forEach(function(i){if(1==i.visible){var s=i[t+"Handler"];if(null==s)throw new Error("Function not found:"+t+"Handler");s.call(i,e)}})},this.add=function(t){for(var e=0;e<this.childs.length;e++)if(this.childs[e]===t)return;t.addTo(this),this.childs.push(t)},this.remove=function(t){if(null==t)throw new Error("Stage.remove出错: 参数为null!");for(var e=0;e<this.childs.length;e++)if(this.childs[e]===t)return t.stage=null,this.childs=this.childs.del(e),this;return this},this.clear=function(){this.childs=[]},this.addEventListener=function(t,e){var i=this,s=function(t){e.call(i,t)};return this.messageBus.subscribe(t,s),this},this.removeEventListener=function(t){this.messageBus.unsubscribe(t)},this.removeAllEventListener=function(){this.messageBus=new Util.MessageBus},this.dispatchEvent=function(t,e){return this.messageBus.publish(t,e),this};var g="click,dbclick,mousedown,mouseup,mouseover,mouseout,mousemove,mousedrag,mousewheel,touchstart,touchmove,touchend,keydown,keyup".split(","),m=this;g.forEach(function(t){m[t]=function(e){null!=e?this.addEventListener(t,e):this.dispatchEvent(t)}}),this.saveImageInfo=function(t,e){var i=this.eagleEye.getImage(t,e),s=window.open("about:blank");return s.document.write("<img src='"+i+"' alt='from canvas'/>"),this},this.saveAsLocalImage=function(t,e){var i=this.eagleEye.getImage(t,e);return i.replace("image/png","image/octet-stream"),window.location.href=i,this},this.paint=function(){null!=this.canvas?(this.graphics.save(),this.graphics.clearRect(0,0,this.width,this.height),this.childs.forEach(function(t){1==t.visible&&t.repaint(u.graphics)}),1==this.eagleEye.visible&&this.eagleEye.paint(this),this.graphics.restore()):console.log('stage|paint canvas error "cavas is null"')},this.repaint=function(){0!=this.frames&&(this.frames<0&&0==this.needRepaint||(this.paint(),this.frames<0&&(this.needRepaint=!1)))},this.zoom=function(t){this.childs.forEach(function(e){0!=e.visible&&e.zoom(t)})},this.zoomOut=function(t){this.childs.forEach(function(e){0!=e.visible&&e.zoomOut(t)})},this.zoomIn=function(t){this.childs.forEach(function(e){0!=e.visible&&e.zoomIn(t)})},this.centerAndZoom=function(){this.childs.forEach(function(t){0!=t.visible&&t.centerAndZoom()})},this.setCenter=function(t,e){var i=this;this.childs.forEach(function(s){var n=t-i.canvas.width/2,a=e-i.canvas.height/2;s.translateX=-n,s.translateY=-a})},this.getBound=function(){var t={left:Number.MAX_VALUE,right:Number.MIN_VALUE,top:Number.MAX_VALUE,bottom:Number.MIN_VALUE};return this.childs.forEach(function(e){var i=e.getElementsBound();i.left<t.left&&(t.left=i.left,t.leftNode=i.leftNode),i.top<t.top&&(t.top=i.top,t.topNode=i.topNode),i.right>t.right&&(t.right=i.right,t.rightNode=i.rightNode),i.bottom>t.bottom&&(t.bottom=i.bottom,t.bottomNode=i.bottomNode)}),t.width=t.right-t.left,t.height=t.bottom-t.top,t},this.toJson=function(){var t=this,e='{"version":"'+Tobj.version+'",';return this.serializedProperties.length,this.serializedProperties.forEach(function(i){var s=t[i];"string"==typeof s&&(s='"'+s+'"'),e+='"'+i+'":'+s+","}),e+='"childs":[',this.childs.forEach(function(t){e+=t.toJson()}),e+="]",e+="}"},function(){0==u.frames?setTimeout(arguments.callee,100):u.frames<0?(u.repaint(),setTimeout(arguments.callee,1e3/-u.frames)):(u.repaint(),setTimeout(arguments.callee,1e3/u.frames))}(),setTimeout(function(){u.mousewheel(function(t){var e=null==t.wheelDelta?t.detail:t.wheelDelta;null!=this.wheelZoom&&(Util.isChrome?e>0?this.zoomOut(this.wheelZoom):this.zoomIn(this.wheelZoom):e>0?this.zoomIn(this.wheelZoom):this.zoomOut(this.wheelZoom))}),u.paint()},300),setTimeout(function(){u.paint()},1e3),setTimeout(function(){u.paint()},3e3)}var Util=require("./_util"),Tobj=require("./_tobj");Stage.prototype={get width(){return this.canvas.width},get height(){return this.canvas.height},set cursor(t){this.canvas.style.cursor=t},get cursor(){return this.canvas.style.cursor},set mode(t){this.childs.forEach(function(e){e.mode=t})}},module.exports=Stage;