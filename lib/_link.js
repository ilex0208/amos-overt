function getLinksArray(t,i){var n=[];if(null==t||null==i)return n;if(t&&i){var e=t.outLinks,s=i.inLinks;if(e&&s)for(var h=0;h<e.length;h++)for(var o=e[h],a=0;a<s.length;a++){var r=s[a];o===r&&n.push(r)}}return n}function getAllLinks(t,i){var n=getLinksArray(t,i),e=getLinksArray(i,t),s=n.concat(e);return s}function getOtherLinksByLink(t){var i=getAllLinks(t.nodeA,t.nodeZ);return i=i.filter(function(i){return t!==i})}function getLinksSize(t,i){return getAllLinks(t,i).length}function Link(t,i,n){function e(t,i){var n=Util.lineF(t.cx,t.cy,i.cx,i.cy),e=t.getBound(),s=Util.intersectionLineBound(n,e);return s}this.initialize=function(t,i,n){if(Link.prototype.initialize.apply(this,arguments),this.elementType="link",this.zIndex=Tobj.zIndex_Link,0!=arguments.length){this.text=n,this.nodeA=t,this.nodeZ=i,this.nodeA&&null==this.nodeA.outLinks&&(this.nodeA.outLinks=[]),this.nodeA&&null==this.nodeA.inLinks&&(this.nodeA.inLinks=[]),this.nodeZ&&null==this.nodeZ.inLinks&&(this.nodeZ.inLinks=[]),this.nodeZ&&null==this.nodeZ.outLinks&&(this.nodeZ.outLinks=[]),null!=this.nodeA&&this.nodeA.outLinks.push(this),null!=this.nodeZ&&this.nodeZ.inLinks.push(this),this.caculateIndex(),this.font="12px Consolas",this.fontColor="255,255,255",this.lineWidth=2,this.lineJoin="miter",this.transformAble=!1,this.bundleOffset=20,this.bundleGap=12,this.textOffsetX=0,this.textOffsetY=0,this.arrowsRadius=null,this.arrowsOffset=0,this.dashedPattern=null,this.path=[];var e="text,font,fontColor,lineWidth,lineJoin".split(",");this.serializedProperties=this.serializedProperties.concat(e)}},this.caculateIndex=function(){var t=getLinksSize(this.nodeA,this.nodeZ);t>0&&(this.nodeIndex=t-1)},this.initialize(t,i,n),this.removeHandler=function(){var t=this;this.nodeA&&this.nodeA.outLinks&&(this.nodeA.outLinks=this.nodeA.outLinks.filter(function(i){return i!==t})),this.nodeZ&&this.nodeZ.inLinks&&(this.nodeZ.inLinks=this.nodeZ.inLinks.filter(function(i){return i!==t}));var i=getOtherLinksByLink(this);i.forEach(function(t,i){t.nodeIndex=i})},this.getStartPosition=function(){var t={x:this.nodeA.cx,y:this.nodeA.cy};return t},this.getEndPosition=function(){var t=void 0;return null!=this.arrowsRadius&&(t=e(this.nodeZ,this.nodeA)),null==t&&(t={x:this.nodeZ.cx,y:this.nodeZ.cy}),t},this.getPath=function(){var t=[],i=this.getStartPosition(),n=this.getEndPosition();if(this.nodeA===this.nodeZ)return[i,n];var e=getLinksSize(this.nodeA,this.nodeZ);if(1==e)return[i,n];var s=Math.atan2(n.y-i.y,n.x-i.x),h={x:i.x+this.bundleOffset*Math.cos(s),y:i.y+this.bundleOffset*Math.sin(s)},o={x:n.x+this.bundleOffset*Math.cos(s-Math.PI),y:n.y+this.bundleOffset*Math.sin(s-Math.PI)},a=s-Math.PI/2,r=s-Math.PI/2,d=e*this.bundleGap/2-this.bundleGap/2,l=this.bundleGap*this.nodeIndex,u={x:h.x+l*Math.cos(a),y:h.y+l*Math.sin(a)},x={x:o.x+l*Math.cos(r),y:o.y+l*Math.sin(r)};return u={x:u.x+d*Math.cos(a-Math.PI),y:u.y+d*Math.sin(a-Math.PI)},x={x:x.x+d*Math.cos(r-Math.PI),y:x.y+d*Math.sin(r-Math.PI)},t.push({x:i.x,y:i.y}),t.push({x:u.x,y:u.y}),t.push({x:x.x,y:x.y}),t.push({x:n.x,y:n.y}),t},this.paintPath=function(t,i){if(this.nodeA===this.nodeZ)return void this.paintLoop(t);t.beginPath(),t.moveTo(i[0].x,i[0].y);for(var n=1;n<i.length;n++)null==this.dashedPattern?t.lineTo(i[n].x,i[n].y):t.AmostDashedLineTo(i[n-1].x,i[n-1].y,i[n].x,i[n].y,this.dashedPattern);if(t.stroke(),t.closePath(),null!=this.arrowsRadius){var e=i[i.length-2],s=i[i.length-1];this.paintArrow(t,e,s)}},this.paintLoop=function(t){var i=this.bundleGap*(this.nodeIndex+1)/2;t.beginPath(),t.arc(this.nodeA.x,this.nodeA.y,i,Math.PI/2,2*Math.PI),t.stroke(),t.closePath()},this.paintArrow=function(t,i,n){var e=this.arrowsOffset,s=this.arrowsRadius/2,h=i,o=n,a=Math.atan2(o.y-h.y,o.x-h.x),r=Util.getDistance(h,o)-this.arrowsRadius,d=h.x+(r+e)*Math.cos(a),l=h.y+(r+e)*Math.sin(a),u=o.x+e*Math.cos(a),x=o.y+e*Math.sin(a);a-=Math.PI/2;var y={x:d+s*Math.cos(a),y:l+s*Math.sin(a)},f={x:d+s*Math.cos(a-Math.PI),y:l+s*Math.sin(a-Math.PI)};t.beginPath(),t.fillStyle="rgba("+this.strokeColor+","+this.alpha+")",t.moveTo(y.x,y.y),t.lineTo(u,x),t.lineTo(f.x,f.y),t.stroke(),t.closePath()},this.paint=function(t){if(null!=this.nodeA&&null!=!this.nodeZ){var i=this.getPath(this.nodeIndex);this.path=i,t.strokeStyle="rgba("+this.strokeColor+","+this.alpha+")",t.lineWidth=this.lineWidth,this.paintPath(t,i),i&&i.length>0&&this.paintText(t,i)}};var s=-(Math.PI/2+Math.PI/4);this.paintText=function(t,i){var n=i[0],e=i[i.length-1];if(4==i.length&&(n=i[1],e=i[2]),this.text&&this.text.length>0){var h=(e.x+n.x)/2+this.textOffsetX,o=(e.y+n.y)/2+this.textOffsetY;t.save(),t.beginPath(),t.font=this.font;var a=t.measureText(this.text).width,r=t.measureText("田").width;if(t.fillStyle="rgba("+this.fontColor+", "+this.alpha+")",this.nodeA===this.nodeZ){var d=this.bundleGap*(this.nodeIndex+1)/2,l=this.nodeA.x+d*Math.cos(s),u=this.nodeA.y+d*Math.sin(s);t.fillText(this.text,l,u)}else t.fillText(this.text,h-a/2,o-r/2);t.stroke(),t.closePath(),t.restore()}},this.paintSelected=function(t){t.shadowBlur=10,t.shadowColor="rgba(0,0,0,1)",t.shadowOffsetX=0,t.shadowOffsetY=0},this.isInBound=function(t,i){if(this.nodeA===this.nodeZ){var n=this.bundleGap*(this.nodeIndex+1)/2,e=Util.getDistance(this.nodeA,{x:t,y:i})-n;return Math.abs(e)<=3}for(var s=!1,h=1;h<this.path.length;h++){var o=this.path[h-1],a=this.path[h];if(1==Util.isPointInLine({x:t,y:i},o,a)){s=!0;break}}return s}}function FoldLink(t,i,n){this.initialize=function(){FoldLink.prototype.initialize.apply(this,arguments),this.direction="horizontal"},this.initialize(t,i,n),this.getStartPosition=function(){var t={x:this.nodeA.cx,y:this.nodeA.cy};return"horizontal"==this.direction?this.nodeZ.cx>t.x?t.x+=this.nodeA.width/2:t.x-=this.nodeA.width/2:this.nodeZ.cy>t.y?t.y+=this.nodeA.height/2:t.y-=this.nodeA.height/2,t},this.getEndPosition=function(){var t={x:this.nodeZ.cx,y:this.nodeZ.cy};return"horizontal"==this.direction?this.nodeA.cy<t.y?t.y-=this.nodeZ.height/2:t.y+=this.nodeZ.height/2:t.x=this.nodeA.cx<t.x?this.nodeZ.x:this.nodeZ.x+this.nodeZ.width,t},this.getPath=function(t){var i=[],n=this.getStartPosition(),e=this.getEndPosition();if(this.nodeA===this.nodeZ)return[n,e];var s=void 0,h=void 0,o=getLinksSize(this.nodeA,this.nodeZ),a=(o-1)*this.bundleGap,r=this.bundleGap*t-a/2;return"horizontal"==this.direction?(s=e.x+r,h=n.y-r,i.push({x:n.x,y:h}),i.push({x:s,y:h}),i.push({x:s,y:e.y})):(s=n.x+r,h=e.y-r,i.push({x:s,y:n.y}),i.push({x:s,y:h}),i.push({x:e.x,y:h})),i},this.paintText=function(t,i){if(this.text&&this.text.length>0){var n=i[1],e=n.x+this.textOffsetX,s=n.y+this.textOffsetY;t.save(),t.beginPath(),t.font=this.font;var h=t.measureText(this.text).width,o=t.measureText("田").width;t.fillStyle="rgba("+this.fontColor+", "+this.alpha+")",t.fillText(this.text,e-h/2,s-o/2),t.stroke(),t.closePath(),t.restore()}}}function FlexionalLink(t,i,n){this.initialize=function(){FlexionalLink.prototype.initialize.apply(this,arguments),this.direction="vertical",this.offsetGap=44},this.initialize(t,i,n),this.getStartPosition=function(){var t={x:this.nodeA.cx,y:this.nodeA.cy};return"horizontal"==this.direction?t.x=this.nodeZ.cx<t.x?this.nodeA.x:this.nodeA.x+this.nodeA.width:t.y=this.nodeZ.cy<t.y?this.nodeA.y:this.nodeA.y+this.nodeA.height,t},this.getEndPosition=function(){var t={x:this.nodeZ.cx,y:this.nodeZ.cy};return"horizontal"==this.direction?t.x=this.nodeA.cx<t.x?this.nodeZ.x:this.nodeZ.x+this.nodeZ.width:t.y=this.nodeA.cy<t.y?this.nodeZ.y:this.nodeZ.y+this.nodeZ.height,t},this.getPath=function(t){var i=this.getStartPosition(),n=this.getEndPosition();if(this.nodeA===this.nodeZ)return[i,n];var e=[],s=getLinksSize(this.nodeA,this.nodeZ),h=(s-1)*this.bundleGap,o=this.bundleGap*t-h/2,a=this.offsetGap;return"horizontal"==this.direction?(this.nodeA.cx>this.nodeZ.cx&&(a=-a),e.push({x:i.x,y:i.y+o}),e.push({x:i.x+a,y:i.y+o}),e.push({x:n.x-a,y:n.y+o}),e.push({x:n.x,y:n.y+o})):(this.nodeA.cy>this.nodeZ.cy&&(a=-a),e.push({x:i.x+o,y:i.y}),e.push({x:i.x+o,y:i.y+a}),e.push({x:n.x+o,y:n.y-a}),e.push({x:n.x+o,y:n.y})),e}}function CurveLink(t,i,n){this.initialize=function(){CurveLink.prototype.initialize.apply(this,arguments)},this.initialize(t,i,n),this.paintPath=function(t,i){if(this.nodeA===this.nodeZ)return void this.paintLoop(t);t.beginPath(),t.moveTo(i[0].x,i[0].y);for(var n=1;n<i.length;n++){var e=i[n-1],s=i[n],h=(e.x+s.x)/2,o=(e.y+s.y)/2;o+=(s.y-e.y)/2,t.strokeStyle="rgba("+this.strokeColor+","+this.alpha+")",t.lineWidth=this.lineWidth,t.moveTo(e.x,e.cy),t.quadraticCurveTo(h,o,s.x,s.y),t.stroke()}if(t.stroke(),t.closePath(),null!=this.arrowsRadius){var a=i[i.length-2],r=i[i.length-1];this.paintArrow(t,a,r)}}}var _e=require("./_baseElement"),Util=require("./_util"),Tobj=require("./_tobj"),InteractiveElement=_e.InteractiveElement;Link.prototype=new InteractiveElement,FoldLink.prototype=new Link,FlexionalLink.prototype=new Link,CurveLink.prototype=new Link,module.exports={Link:Link,FoldLink:FoldLink,FlexionalLink:FlexionalLink,CurveLink:CurveLink};