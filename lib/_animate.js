function Step(t,n){var e=void 0,r=null;return{stop:function(){return e?(window.clearInterval(e),r&&r.publish("stop"),this):this},start:function(){var r=this;return e=setInterval(function(){t.call(r)},n),this},onStop:function(t){return null==r&&(r=new Util.MessageBus),r.subscribe("stop",t),this}}}function gravity(t,n){function e(){return window.clearInterval(a),s.onStop&&s.onStop(t),s}function r(){var r=n.dx||0,u=n.dy||2;return a=setInterval(function(){return isStopAll?void s.stop():(u+=i,void(t.y+t.height<o.stage.canvas.height?t.setLocation(t.x+r,t.y+u):(u=0,e())))},20),s}var o=n.context,i=n.gravity||.1,a=null,s={};return s.run=r,s.stop=e,s.onStop=function(t){return s.onStop=t,s},s}function stepByStep(t,n,e,r,o){var i=1e3/24,a={};for(var s in n){var u=n[s],l=u-t[s];a[s]={oldValue:t[s],targetValue:u,step:l/e*i,isDone:function(n){var e=this.step>0&&t[n]>=this.targetValue||this.step<0&&t[n]<=this.targetValue;return e}}}var c=new Step(function(){var e=!0;for(var i in n)a[i].isDone(i)||(t[i]+=a[i].step,e=!1);if(e){if(!r)return this.stop();for(var s in n)if(o){var u=a[s].targetValue;a[s].targetValue=a[s].oldValue,a[s].oldValue=u,a[s].step=-a[s].step}else t[s]=a[s].oldValue}return this},i);return c}function spring(t){null==t&&(t={});var n=t.spring||.1,e=t.friction||.8,r=t.grivity||0,o=(t.wind||0,t.minLength||0);return{items:[],timer:null,isPause:!1,addNode:function(t,n){var e={node:t,target:n,vx:0,vy:0};return this.items.push(e),this},play:function(t){this.stop(),t=null==t?1e3/24:t;var n=this;this.timer=setInterval(function(){n.nextFrame()},t)},stop:function(){null!=this.timer&&window.clearInterval(this.timer)},nextFrame:function(){for(var t=0;t<this.items.length;t++){var i=this.items[t],a=i.node,s=i.target,u=i.vx,l=i.vy,c=s.x-a.x,v=s.y-a.y,p=Math.atan2(v,c);if(0!=o){var h=s.x-Math.cos(p)*o,f=s.y-Math.sin(p)*o;u+=(h-a.x)*n,l+=(f-a.y)*n}else u+=c*n,l+=v*n;u*=e,l*=e,l+=r,a.x+=u,a.y+=l,i.vx=u,i.vy=l}}}}function rotate(t,n){function e(){return o=setInterval(function(){return isStopAll?void i.stop():(t.rotate+=a||.2,void(t.rotate>2*Math.PI&&(t.rotate=0)))},100),i}function r(){return window.clearInterval(o),i.onStop&&i.onStop(t),i}var o=null,i={},a=n.v;return i.run=e,i.stop=r,i.onStop=function(t){return i.onStop=t,i},i}function dividedTwoPiece(t,n){function e(n,e,r,o,i){var a=new Node;return a.setImage(t.image),a.setSize(t.width,t.height),a.setLocation(n,e),a.draw=function(t){t.save(),t.arc(0,0,r,o,i),t.clip(),t.beginPath(),void 0!=this.image&&null!=this.image?t.drawImage(this.image,-this.width/2,-this.height/2):(t.fillStyle="rgba("+this.style.fillStyle+","+this.alpha+")",t.rect(-this.width/2,-this.height/2,this.width/2,this.height/2),t.fill()),t.closePath(),t.restore()},a}function r(n,r){var o=n,i=n+Math.PI,a=e(t.x,t.y,t.width,o,i),u=e(t.x-2+4*Math.random(),t.y,t.width,o+Math.PI,o);t.visible=!1,r.add(a),r.add(u),gravity(a,{context:r,dx:.3}).run().onStop(function(t){r.remove(a),r.remove(u),s.stop()}),gravity(u,{context:r,dx:-.2}).run()}function o(){return r(n.angle,a),s}function i(){return s.onStop&&s.onStop(t),s}var a=n.context,s={};return s.onStop=function(t){return s.onStop=t,s},s.run=o,s.stop=i,s}function repeatThrow(t,n){function e(t){t.setVisible(!0),t.rotate=Math.random();var n=a.stage.canvas.width/2;t.x=n+Math.random()*(n-100)-Math.random()*(n-100),t.y=a.stage.canvas.height,t.vx=5*Math.random()-5*Math.random(),t.vy=-25}function r(){return e(t),s=setInterval(function(){return isStopAll?void u.stop():(t.vy+=i,t.x+=t.vx,t.y+=t.vy,void((t.x<0||t.x>a.stage.canvas.width||t.y>a.stage.canvas.height)&&(u.onStop&&u.onStop(t),e(t))))},50),u}function o(){window.clearInterval(s)}var i=.8,a=n.context,s=null,u={};return u.onStop=function(t){return u.onStop=t,u},u.run=r,u.stop=o,u}function stopAll(){isStopAll=!0}function startAll(){isStopAll=!1}function cycle(t,n){function e(){return p=setInterval(function(){if(isStopAll)return void v.stop();var n=o.y+a+Math.sin(l)*u;t.setLocation(t.x,n),l+=c},100),v}function r(){window.clearInterval(p)}var o=n.p1,i=n.p2,a=o.x+(i.x-o.x)/2,s=o.y+(i.y-o.y)/2,u=Util.getDistance(o,i)/2,l=Math.atan2(s,a),c=n.speed||.2,v={},p=null;return v.run=e,v.stop=r,v}function move(t,n){function e(){return s=setInterval(function(){if(isStopAll)return void a.stop();var n=o.x-t.x,e=o.y-t.y,s=n*i,u=e*i;t.x+=s,t.y+=u,s<.01&&u<.1&&r()},100),a}function r(){window.clearInterval(s)}var o=n.position,i=n.easing||.2,a={},s=null;return a.onStop=function(t){return a.onStop=t,a},a.run=e,a.stop=r,a}function scale(t,n){function e(){return l=setInterval(function(){t.scaleX+=i,t.scaleY+=i,t.scaleX>=o&&r()},100),u}function r(){u.onStop&&u.onStop(t),t.scaleX=a,t.scaleY=s,window.clearInterval(l)}var o=n.scale||1,i=.06,a=t.scaleX,s=t.scaleY,u={},l=null;return u.onStop=function(t){return u.onStop=t,u},u.run=e,u.stop=r,u}var _n=require("./_node"),Util=require("./_util"),Node=_n.Node,isStopAll=!1,Animate={stepByStep:stepByStep,rotate:rotate,scale:scale,move:move,cycle:cycle,repeatThrow:repeatThrow,dividedTwoPiece:dividedTwoPiece,gravity:gravity,startAll:startAll,stopAll:stopAll},Effect={spring:spring,gravity:gravity};module.exports={Effect:Effect,Animate:Animate};