var _tool=require("./../common/_tool"),List=require("./../core/_list"),__tree=function t(e,i){e._rootVisible=!0,e._initTree=function(){this._rootData=null,this._expandMap={},this._levelMap={}},e.validateModel=function(){this._rowDatas.clear(),this._levelMap={},this._dataRowMap={},this._currentLevel=0,this._rootData?this._rootVisible?this.isVisible(this._rootData)&&this._buildData(this._rootData):this._buildChildren(this._rootData):this._buildChildren(),delete this._currentLevel},e._buildData=function(t){this._dataRowMap[t.getId()]=this._rowDatas.size(),this._rowDatas.add(t),this._levelMap[t.getId()]=this._currentLevel,this.isExpanded(t)&&(this._currentLevel++,this._buildChildren(t),this._currentLevel--)},e._buildChildren=function(t){var e=t?t.getChildren():this._box.getRoots(),i=this.getCurrentSortFunction();i&&this.isChildrenSortable(t)?e.toList(this.isVisible,this).sort(i).forEach(function(t){this._buildData(t)},this):e.forEach(function(t){this.isVisible(t)&&this._buildData(t)},this)},e.getLevel=function(t){return this._levelMap[t.getId()]},e.getToggleImage=function(t){return t.getChildrenSize()>0?this.isExpanded(t)?this._expandIcon:this._collapseIcon:null},e.isCheckable=function(t){return this.isCheckMode()},e.isCheckMode=function(){return 1===t._checkMap[this._checkMode]},e.isChildrenSortable=function(t){return!0},e.handleDataBoxChange=function(t){"remove"===t.kind?delete this._expandMap[t.data.getId()]:"clear"===t.kind&&(this._expandMap={}),this.invalidateModel()},e.isExpanded=function(t){return 1===this._expandMap[t.getId()]},e.expand=function(t){if(!this.isExpanded(t)){for(var e=t.getParent();null!=e&&e!==this._rootData;)this._expandMap[e.getId()]=1,e=e.getParent();this._expandMap[t.getId()]=1,this.invalidateModel()}},e.collapse=function(t){this.isExpanded(t)&&(delete this._expandMap[t.getId()],this.invalidateModel())},e.expandAll=function(){this._box.forEach(function(t){this._expandMap[t.getId()]=1},this),this.invalidateModel()},e.collapseAll=function(){this._expandMap={},this.invalidateModel()},e._handleClick=function(t){if(this.isFocusOnClick()&&_tool.setFocus(this._view),!this._isValidating){var e;if(t.target._expandData)e=t.target._expandData,this.isExpanded(e)?(this.collapse(e),this.fireInteractionEvent({kind:"collapse",data:e})):(this.expand(e),this.fireInteractionEvent({kind:"expand",data:e}));else if(t.target._selectData||t.target.parentNode._selectData){if(this._handlePressSelection(t.target._selectData||t.target.parentNode._selectData,t),this.isCheckMode()){var i=this.getRowIndexAt(t);i>=0&&this.__handleClick(t)}}else this._treeColumn?(e=this.getDataAt(t),e&&(this.isCheckMode()?t.target._checkData||this.__handleClick(t):this._handlePressSelection(e,t))):this.isCheckMode()&&!t.target._checkData&&this.__handleClick(t);this._currentEditor&&!this._isCommitting&&(this._isCommitting=!0,this.commitEditValue(this._currentEditor._editInfo,this._currentEditor)),this.updateCurrentEditor&&this.updateCurrentEditor(t)}},e.__handleClick=function(t){var e=this.getDataAt(t),i=this.getRowIndexByData(e);if(this._focusedRow!==i){var a=this._rowDatas.get(this._focusedRow);this._focusedRow=i,a&&this.invalidateData(a),this.invalidateData(e)}},e.handleChange=function(t){if(!(this._isCommitting||this._isCanceling||this._isValidating)){var e=t.target._checkData;if(e){var i,a=this.isSelected(e),s=this.getSelectionModel();if("default"===this._checkMode)a?s.removeSelection(e):s.appendSelection(e);else if("children"===this._checkMode)i=new List(e),i.addAll(e.getChildren());else if("descendant"===this._checkMode)i=new List,_tool.fillDescendant(e,i);else if("descendantAncestor"===this._checkMode&&(i=new List,_tool.fillDescendant(e,i),!a))for(var n=e.getParent();n;)i.add(n),n=n.getParent();a?s.removeSelection(i):s.appendSelection(i)}t.target._editInfo&&this.commitEditValue&&(this._isCommitting=!0,this.commitEditValue(t.target._editInfo,t.target))}},e.onLabelRendered=function(t,e,i,a,s,n){},this._renderTree=function(t,e,i,a){var s=this._levelMap[e.getId()],n=this.getToggleImage(e),l=this.__spanPool.get();if(n?l.style.width=this._indent*s+"px":l.style.width=this._indent*(s+1)+"px",l.style.display="inline-block",t.appendChild(l),n){var h=this.__imagePool.get();h.setAttribute("src",e.getImageSrc(n)),h.style.verticalAlign="middle",h._expandData=e,t.appendChild(h)}var d=this.isCheckable(e),o="disabled"===this.getUncheckableStyle();if(d||o){var r=this._addCheckBox(t,e,a);r.disabled=!d}var c=this.getIcon(e);if(c){var _=this.isCheckMode()||this._treeColumn?null:e;this._addIcon(t,e,c,_)}var u=this.getLabel(e);u&&(l=this.__textPool.get(),l.style.whiteSpace="nowrap",l.style.verticalAlign="middle",l.style.padding="1px 2px 1px 2px",_tool.setText(l,u,this._treeColumn?this._treeColumn.isInnerText():this._innerText),this.isCheckMode()||this._treeColumn?this._focusedRow===i&&(l.style.backgroundColor=this.getSelectColor(e)):(l._selectData=e,l.style.backgroundColor=a?this.getSelectColor(e):""),this.onLabelRendered(l,e,u,i,s,a),t.appendChild(l))}};__tree._checkMap={default:1,children:1,descendant:1,descendantAncestor:1},module.exports=__tree;