var DataBox=require("./_db"),AlarmElementMapping=require("./_AlarmElementMapping"),invokeExtends=require("./../core/_ext"),AlarmBox=function e(a){if(!a)throw"elementBox can not be null.";e.superClass.constructor.call(this),this._elementBox=a,this._alarmElementMapping=new AlarmElementMapping(this,a),this._elementBox.addDataBoxChangeListener(this.handleElementBoxChange,this,!0),this.addDataBoxChangeListener(this.handleAlarmBoxChange,this,!0),this.addDataPropertyChangeListener(this.handleAlarmPropertyChange,this,!0),this.__accessor=["removeAlarmWhenElementIsRemoved"],this._name="AlarmBox",this._removeAlarmWhenAlarmIsCleared=!1,this._removeAlarmWhenElementIsRemoved=!0,this.getElementBox=function(){return this._elementBox},this.isRemoveAlarmWhenAlarmIsCleared=function(){return this._removeAlarmWhenAlarmIsCleared},this.setRemoveAlarmWhenAlarmIsCleared=function(e){var a=this._removeAlarmWhenAlarmIsCleared;this._removeAlarmWhenAlarmIsCleared=e,this.firePropertyChange("removeAlarmWhenAlarmIsCleared",a,e),e&&this.toDatas(function(e){return e.isCleared()}).forEach(this.remove,this)},this.getAlarmElementMapping=function(){return this._alarmElementMapping},this.setAlarmElementMapping=function(e){if(!e)throw"alarmElementMapping can not be null";if(this._alarmElementMapping!==e){var a=this._alarmElementMapping;this.getDatas().forEach(this._decreaseAlarmState,this),this._alarmElementMapping=e,this.getDatas().forEach(this._increaseAlarmState,this),this.firePropertyChange("alarmElementMapping",a,e)}},this.handleElementBoxChange=function(e){"add"===e.kind?this.handleElementAdded(e.data):"remove"===e.kind?(this.handleElementRemoved(e.data),this._removeAlarmWhenElementIsRemoved&&this.removeAlarmsByElement(e.data)):"clear"===e.kind&&(e.datas.forEach(this.handleElementRemoved,this),this._removeAlarmWhenElementIsRemoved&&this.clear())},this.handleAlarmBoxChange=function(e){"add"===e.kind?this._increaseAlarmState(e.data):"remove"===e.kind?this._decreaseAlarmState(e.data):"clear"===e.kind&&e.datas.forEach(this._decreaseAlarmState,this)},this.handleAlarmPropertyChange=function(e){var a=e.source;a.isCleared()||("alarmSeverity"===e.property?this.handleAlarmSeverityChange(a,e):"acked"===e.property&&this.handleAckedChange(a,e)),"cleared"===e.property&&(a.isCleared()?(this._decreaseAlarmState(a,!0),this._removeAlarmWhenAlarmIsCleared&&this.remove(a)):this._increaseAlarmState(a,!0))},this.handleAckedChange=function(e,a){if(e.getAlarmSeverity()){var t=this.getCorrespondingElements(e);if(t)for(var r=0;r<t.size();r++){var n=t.get(r);a.oldValue?n.getAlarmState().decreaseAcknowledgedAlarm(e.getAlarmSeverity()):n.getAlarmState().decreaseNewAlarm(e.getAlarmSeverity()),a.newValue?n.getAlarmState().increaseAcknowledgedAlarm(e.getAlarmSeverity()):n.getAlarmState().increaseNewAlarm(e.getAlarmSeverity())}}},this.handleAlarmSeverityChange=function(e,a){var t=a.oldValue,r=a.newValue,n=this.getCorrespondingElements(e);if(n)for(var i=0;i<n.size();i++){var l=n.get(i);t&&(e.isAcked()?l.getAlarmState().decreaseAcknowledgedAlarm(t):l.getAlarmState().decreaseNewAlarm(t)),r&&(e.isAcked()?l.getAlarmState().increaseAcknowledgedAlarm(r):l.getAlarmState().increaseNewAlarm(r))}},this.getCorrespondingAlarms=function(e){return this._alarmElementMapping.getCorrespondingAlarms(e)},this.getCorrespondingElements=function(e){return this._alarmElementMapping.getCorrespondingElements(e)},this.handleElementAdded=function(e){var a=this.getCorrespondingAlarms(e);if(a)for(var t=0;t<a.size();t++){var r=a.get(t);if(!r.isCleared()){var n=r.getAlarmSeverity();n&&(r.isAcked()?e.getAlarmState().increaseAcknowledgedAlarm(n):e.getAlarmState().increaseNewAlarm(n))}}},this._increaseAlarmState=function(e,a){if(!e.isCleared()||a){var t=e.getAlarmSeverity();if(t){var r=this.getCorrespondingElements(e);if(r)for(var n=0;n<r.size();n++){var i=r.get(n);e.isAcked()?i.getAlarmState().increaseAcknowledgedAlarm(t):i.getAlarmState().increaseNewAlarm(t)}}}},this._decreaseAlarmState=function(e,a){if(!e.isCleared()||a){var t=e.getAlarmSeverity();if(t){var r=this.getCorrespondingElements(e);if(r)for(var n=0;n<r.size();n++){var i=r.get(n);e.isAcked()?i.getAlarmState().decreaseAcknowledgedAlarm(t):i.getAlarmState().decreaseNewAlarm(t)}}}},this.handleElementRemoved=function(e){var a=this.getCorrespondingAlarms(e);a&&a.forEach(function(a){!a.isCleared()&&a.getAlarmSeverity()&&(a.isAcked()?e.getAlarmState().decreaseAcknowledgedAlarm(a.getAlarmSeverity()):e.getAlarmState().decreaseNewAlarm(a.getAlarmSeverity()))})},this.removeAlarmsByElement=function(e){var a=this.getCorrespondingAlarms(e);a&&a.forEach(this.remove,this)},this.add=function(a,t){if(!a.IAlarm)throw"Only IAlarm can be added into AlarmBox";this._removeAlarmWhenAlarmIsCleared&&a.isCleared()||e.superClass.add.apply(this,arguments)}};invokeExtends("third.AlarmBox",DataBox,AlarmBox),AlarmBox.prototype.getClassName=function(){return"third.AlarmBox"},module.exports=AlarmBox;