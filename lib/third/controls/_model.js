var EventDispatcher=require("./_eventDispatcher"),List=require("./../core/_list"),PropertyChangeDispatcher=require("./_PropertyChangeDispatcher"),invokeExtends=require("./../core/_ext"),SelectionModel=function e(t){e.superClass.constructor.apply(this,arguments),this._selectionMode="multipleSelection",this._selectionList=new List,this._selectionChangeDispatcher=new EventDispatcher,this._selectionMap={},this.getSelectionMode=function(){return this._selectionMode},this.setSelectionMode=function(e){if(this._selectionMode!==e&&("noneSelection"===e||"singleSelection"===e||"multipleSelection"===e)){this.clearSelection();var t=this._selectionMode;this._selectionMode=e,this.firePropertyChange("selectionMode",t,this._selectionMode)}},this.getDataBox=function(){return this._dataBox},this._setDataBox=function(e){if(!e)throw"dataBox can not be null";if(this._dataBox!==e){this._dataBox&&(this.clearSelection(),this._dataBox.removeDataBoxChangeListener(this.handleDataBoxChange,this));var t=this._dataBox;this._dataBox=e,this._dataBox.addDataBoxChangeListener(this.handleDataBoxChange,this,!0),this.firePropertyChange("dataBox",t,this._dataBox)}},this.dispose=function(){this.clearSelection(),this._dataBox.removeDataBoxChangeListener(this.handleDataBoxChange,this)},this.handleDataBoxChange=function(e){if("remove"===e.kind){var t=e.data;this.contains(t)&&(this._selectionList.remove(t),delete this._selectionMap[t.getId()],this.fireSelectionChange("remove",new List(t)))}else"clear"===e.kind&&this.clearSelection()},this.getFilterFunction=function(){return this._filterFunction},this.setFilterFunction=function(e){if(this._filterFunction!==e){this.clearSelection();var t=this._filterFunction;this._filterFunction=e,this.firePropertyChange("filterFunction",t,this._filterFunction)}},this.fireSelectionChange=function(e,t,i){i&&(this._selectionList.forEach(function(e){i.contains(e)?i.remove(e):i.add(e)}),t=i.toList()),this._selectionChangeDispatcher.fire({kind:e,datas:new List(t)})},this.addSelectionChangeListener=function(e,t,i){this._selectionChangeDispatcher.add(e,t,i)},this.removeSelectionChangeListener=function(e,t){this._selectionChangeDispatcher.remove(e,t)},this._filterList=function(e,t){for(var i=new List(e),s=0;s<i.size();s++){var n=i.get(s);(this._filterFunction&&!this._filterFunction(n)||t&&this.contains(n)||!t&&!this.contains(n)||!this._dataBox.contains(n))&&(i.removeAt(s),s--)}return i},this.appendSelection=function(e){if("noneSelection"!==this._selectionMode){var t=this._filterList(e,!0);if(!t.isEmpty()){var i=null;"singleSelection"===this._selectionMode&&(i=new List(this._selectionList),this._selectionList.clear(),this._selectionMap={},t=new List(t.get(t.size()-1)));for(var s=0;s<t.size();s++){var n=t.get(s);this._selectionList.add(n),this._selectionMap[n.getId()]=n}this.fireSelectionChange("append",t,i)}}},this.removeSelection=function(e){var t=this._filterList(e);if(0!==t.size()){for(var i=0;i<t.size();i++){var s=t.get(i);this._selectionList.remove(s),delete this._selectionMap[s.getId()]}this.fireSelectionChange("remove",t)}},this.toSelection=function(e,t){return this._selectionList.toList(e,t)},this.getSelection=function(){return this._selectionList},this.setSelection=function(e){if("noneSelection"!==this._selectionMode&&(0!==this._selectionList.size()||null!=e)){var t=new List(this._selectionList);this._selectionList.clear(),this._selectionMap={};var i=this._filterList(e,!0);"singleSelection"===this._selectionMode&&i.size()>1&&(i=new List(i.get(i.size()-1)));for(var s=0;s<i.size();s++){var n=i.get(s);this._selectionList.add(n),this._selectionMap[n.getId()]=n}this.fireSelectionChange("set",null,t)}},this.clearSelection=function(){if(this._selectionList.size()>0){var e=this._selectionList.toList();this._selectionList.clear(),this._selectionMap={},this.fireSelectionChange("clear",e)}},this.selectAll=function(){if("noneSelection"!==this._selectionMode){var e=this._dataBox.toDatas(),t=0,i=null;if(this._filterFunction)for(t=0;t<e.size();t++)i=e.get(t),this._filterFunction(i)||(e.removeAt(t),t--);var s=new List(this._selectionList);for(this._selectionList.clear(),this._selectionMap={},"singleSelection"===this._selectionMode&&e.size()>1&&(e=new List(e.get(e.size()-1))),t=0;t<e.size();t++)i=e.get(t),this._selectionList.add(i),this._selectionMap[i.getId()]=i;this.fireSelectionChange("all",null,s)}},this.size=function(){return this._selectionList.size()},this.contains=function(e){return!!e&&null!=this._selectionMap[e.getId()]},this.getLastData=function(){return this._selectionList.size()>0?this._selectionList.get(this._selectionList.size()-1):null},this.getFirstData=function(){return this._selectionList.size()>0?this._selectionList.get(0):null},this.isSelectable=function(e){return!!e&&("noneSelection"!==this._selectionMode&&!(this._filterFunction&&!this._filterFunction(e)))},this._setDataBox(t)};invokeExtends("third.SelectionModel",PropertyChangeDispatcher,SelectionModel),SelectionModel.prototype.getClassName=function(){return"third.SelectionModel"},module.exports=SelectionModel;