var EventDispatcher=require("./_eventDispatcher"),SelectionModel=require("./_model"),PropertyChangeDispatcher=require("./_PropertyChangeDispatcher"),List=require("./../core/_list"),_con=require("./../constants/index"),Bd=_con.Bd,Tnode=require("./../eles/_tNode"),Tlink=require("./../eles/_tLink"),Follower=require("./../eles/_Follower"),box=require("./_box"),invokeExtends=require("./../core/_ext"),DataBox=function t(i){t.superClass.constructor.apply(this,arguments),1===arguments.length&&(this._name=i),this._dataList=new List,this._dataMap={},this._rootList=new List,this._rootMap={},this._clientMap={},this._dataBoxChangeDispatcher=new EventDispatcher,this._dataPropertyChangeDispatcher=new EventDispatcher,this._hierarchyChangeDispatcher=new EventDispatcher,this._selectionModel=new SelectionModel(this),this.IClient=!0,this.__client=1,this.__new=1,this._limit=-1,this._name="DataBox",this._icon=Bd.ICON_DATABOX,this.__accessor=["name","icon","toolTip"],this.getSelectionModel=function(){return this._selectionModel},this.size=function(){return this._dataList.size()},this.isEmpty=function(){return this._dataList.isEmpty()},this.getLimit=function(){return this._limit},this.setLimit=function(t){var i=this._limit;this._limit=t,this.firePropertyChange("limit",i,t),this._checkLimit()},this._checkLimit=function(){this._limit>=0&&this.size()>this._limit&&this.removeFirst(this.size()-this._limit)},this.removeFirst=function(t){for(0===arguments.length&&(t=1);t>0&&this._dataList.size()>0;){var i=this._dataList.get(0);this.remove(i),t--}},this.getSiblings=function(t){if(!this.contains(t))throw t+" dosen't belong to this dataBox";var i=t.getParent();return i?i.getChildren():this._rootList},this.getRoots=function(){return this._rootList},this.getSiblingIndex=function(t){return t.getParent()?t.getParent().getChildren().indexOf(t):this._rootList.indexOf(t)},this.getDatas=function(){return this._dataList},this.getDataAt=function(t){return this._dataList.get(t)},this.toDatas=function(t,i){return this._dataList.toList(t,i)},this.forEach=function(t,i){this._dataList.forEach(t,i)},this.forEachReverse=function(t,i){this._dataList.forEachReverse(t,i)},this.forEachByDepthFirst=function(t,i,e){if(i)this._depthFirst(t,i,e);else for(var s=this._rootList.size(),o=0;o<s;o++){var a=this._rootList.get(o);if(this._depthFirst(t,a,e)===!1)return}},this._depthFirst=function(t,i,e){for(var s=i.getChildrenSize(),o=0;o<s;o++){var a=i.getChildAt(o);if(this._depthFirst(t,a,e)===!1)return!1}if(e){if(t.call(e,i)===!1)return!1}else if(t(i)===!1)return!1},this.forEachByBreadthFirst=function(t,i,e){var s=new List;for(i?s.add(i):this._rootList.forEach(s.add,s);s.size()>0;)if(i=s.removeAt(0),i.getChildren().forEach(s.add,s),e){if(t.call(e,i)===!1)return}else if(t(i)===!1)return},this.add=function(t,i){if(t){1===arguments.length&&(i=-1);var e=t.getId();if(this._dataMap.hasOwnProperty(e))throw"Data with ID '"+e+"' already exists";this._dataMap[e]=t,this._dataList.add(t),t.getParent()||(this._rootMap[e]=t,i>=0?this._rootList.add(t,i):this._rootList.add(t)),t.addPropertyChangeListener(this.handleDataPropertyChange,this,!0),this._dataBoxChangeDispatcher.fire({kind:"add",data:t}),this._checkLimit()}},this.remove=function(t){this.removeById(t.getId())},this.removeSelection=function(){this._selectionModel.toSelection().forEach(function(t){this.remove(t)},this)},this.removeById=function(t){var i=this.getDataById(t);i&&(i instanceof Tlink&&(i.setFromNode(null),i.setToNode(null)),i instanceof Tnode&&i.getLinks()&&i.getLinks().toList().forEach(function(t){this.remove(t)},this),i instanceof Tnode&&i.getFollowers()&&i.getFollowers().toList().forEach(function(t){t.setHost(null)}),i instanceof Follower&&i.getHost()&&i.setHost(null),i.toChildren().forEach(function(t){this.remove(t)},this),i.getParent()&&i.getParent().removeChild(i),this._dataList.remove(i),delete this._dataMap[t],this._rootMap[t]&&(delete this._rootMap[t],this._rootList.remove(i)),this._dataBoxChangeDispatcher.fire({kind:"remove",data:i}),i.removePropertyChangeListener(this.handleDataPropertyChange,this))},this.clear=function(){if(this._dataList.size()>0){this._dataList.forEach(function(t){t.removePropertyChangeListener(this.handleDataPropertyChange,this)},this);var t=this._dataList.toList();this._dataList.clear(),this._dataMap={},this._rootList.clear(),this._rootMap={},this._dataBoxChangeDispatcher.fire({kind:"clear",datas:t})}},this.getDataById=function(t){return this._dataMap[t]},this.containsById=function(t){return this._dataMap.hasOwnProperty(t)},this.contains=function(t){return!!t&&this._dataMap[t._id]===t},this.moveTo=function(t,i){if(!this.contains(t))throw t+" dosen't belong to this dataBox";var e=this.getSiblings(t),s=e.indexOf(t);s===i||s<0||i>=0&&i<=e.size()&&(e.remove(t),i>e.size()&&i--,e.add(t,i),this._hierarchyChangeDispatcher.fire({data:t,oldIndex:s,newIndex:i}))},this.moveUp=function(t){var i=this.getSiblings(t);this.moveTo(t,i.indexOf(t)-1)},this.moveDown=function(t){var i=this.getSiblings(t);this.moveTo(t,i.indexOf(t)+1)},this.moveToTop=function(t){this.moveTo(t,0)},this.moveToBottom=function(t){var i=this.getSiblings(t);this.moveTo(t,i.size())},this.moveSelectionUp=function(t){t||(t=this._selectionModel);var i=new List;box.findMoveUpDatas(t,i,this._rootList),i.forEach(this.moveUp,this)},this.moveSelectionDown=function(t){t||(t=this._selectionModel);var i=new List;box.findMoveDownDatas(t,i,this._rootList),i.forEach(this.moveDown,this)},this.moveSelectionToTop=function(t){t||(t=this._selectionModel);var i=new List;box.findMoveToTopDatas(t,i,this._rootList),i.forEach(this.moveToTop,this)},this.moveSelectionToBottom=function(t){t||(t=this._selectionModel);var i=new List;box.findMoveToBottomDatas(t,i,this._rootList),i.forEach(this.moveToBottom,this)},this.handleDataPropertyChange=function(t){var i=t.source;if("parent"===t.property){var e=i.getId();i.getParent()?this._rootMap[e]&&(delete this._rootMap[e],this._rootList.remove(i)):this._rootMap[e]||(this._rootMap[e]=i,this._rootList.add(i))}this.onDataPropertyChanged(i,t),this._dataPropertyChangeDispatcher.fire(t)},this.onDataPropertyChanged=function(t,i){},this.addDataBoxChangeListener=function(t,i,e){this._dataBoxChangeDispatcher.add(t,i,e)},this.removeDataBoxChangeListener=function(t,i){this._dataBoxChangeDispatcher.remove(t,i)},this.addDataPropertyChangeListener=function(t,i,e){this._dataPropertyChangeDispatcher.add(t,i,e)},this.removeDataPropertyChangeListener=function(t,i){this._dataPropertyChangeDispatcher.remove(t,i)},this.addHierarchyChangeListener=function(t,i,e){this._hierarchyChangeDispatcher.add(t,i,e)},this.removeHierarchyChangeListener=function(t,i){this._hierarchyChangeDispatcher.remove(t,i)}};invokeExtends("third.DataBox",PropertyChangeDispatcher,DataBox),DataBox.prototype.getClassName=function(){return"third.DataBox"},module.exports=DataBox;