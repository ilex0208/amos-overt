function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function Scene(e){function t(e,t,s,n){return function(i){i.beginPath(),i.strokeStyle="rgba(0,0,236,0.5)",i.fillStyle="rgba(0,0,236,0.1)",i.rect(e,t,s,n),i.fill(),i.stroke(),i.closePath()}}var s=this;this.initialize=function(){Scene.prototype.initialize.apply(this,arguments),this.messageBus=new Util.MessageBus,this.elementType="scene",this.childs=[],this.zIndexMap={},this.zIndexArray=[],this.backgroundColor="255,255,255",this.visible=!0,this.alpha=0,this.scaleX=1,this.scaleY=1,this.mode=SceneMode.normal,this.translate=!0,this.translateX=0,this.translateY=0,this.lastTranslateX=0,this.lastTranslateY=0,this.mouseDown=!1,this.mouseDownX=null,this.mouseDownY=null,this.mouseDownEvent=null,this.areaSelect=!0,this.operations=[],this.selectedElements=[],this.paintAll=!1;var e="background,backgroundColor,mode,paintAll,areaSelect,translate,translateX,translateY,lastTranslatedX,lastTranslatedY,alpha,visible,scaleX,scaleY".split(",");this.serializedProperties=this.serializedProperties.concat(e)},this.initialize(),this.setBackground=function(e){this.background=e},this.addTo=function(e){this.stage!==e&&null!=e&&(this.stage=e)},null!=e&&(e.add(this),this.addTo(e)),this.show=function(){this.visible=!0},this.hide=function(){this.visible=!1},this.paint=function(e){if(0!=this.visible&&null!=this.stage){if(e.save(),this.paintBackgroud(e),e.restore(),e.save(),e.scale(this.scaleX,this.scaleY),1==this.translate){var t=this.getOffsetTranslate(e);e.translate(t.translateX,t.translateY)}this.paintChilds(e),e.restore(),e.save(),this.paintOperations(e,this.operations),e.restore()}},this.repaint=function(e){!1!==this.visible&&this.paint(e)},this.paintBackgroud=function(e){null!=this.background?e.drawImage(this.background,0,0,e.canvas.width,e.canvas.height):(e.beginPath(),e.fillStyle="rgba("+this.backgroundColor+","+this.alpha+")",e.fillRect(0,0,e.canvas.width,e.canvas.height),e.closePath())},this.getDisplayedElements=function(){for(var e=[],t=0;t<this.zIndexArray.length;t++)for(var s=this.zIndexArray[t],n=this.zIndexMap[s],i=0;i<n.length;i++){var a=n[i];this.isVisiable(a)&&e.push(a)}return e},this.getDisplayedNodes=function(){for(var e=[],t=0;t<this.childs.length;t++){var s=this.childs[t];s instanceof Node&&this.isVisiable(s)&&e.push(s)}return e},this.paintChilds=function(e){for(var t=0;t<this.zIndexArray.length;t++)for(var s=this.zIndexArray[t],n=this.zIndexMap[s],i=0;i<n.length;i++){var a=n[i];if(!0===this.paintAll||this.isVisiable(a)){if(e.save(),!0===a.transformAble){var r=a.getCenterLocation();e.translate(r.x,r.y),a.rotate&&e.rotate(a.rotate),a.scaleX&&a.scaleY?e.scale(a.scaleX,a.scaleY):a.scaleX?e.scale(a.scaleX,1):a.scaleY&&e.scale(1,a.scaleY)}!0===a.shadow&&(e.shadowBlur=a.shadowBlur,e.shadowColor=a.shadowColor,e.shadowOffsetX=a.shadowOffsetX,e.shadowOffsetY=a.shadowOffsetY),a instanceof InteractiveElement&&(a.selected&&!0===a.showSelected&&a.paintSelected(e),!0===a.isMouseOver&&a.paintMouseover(e)),a.paint(e),e.restore()}}},this.getOffsetTranslate=function(e){var t=this.stage.canvas.width,s=this.stage.canvas.height;null!=e&&"move"!=e&&(t=e.canvas.width,s=e.canvas.height);var n=t/this.scaleX/2,i=s/this.scaleY/2,a={translateX:this.translateX+(n-n*this.scaleX),translateY:this.translateY+(i-i*this.scaleY)};return a},this.isVisiable=function(e){if(!0!==e.visible)return!1;if(e instanceof Link)return!0;var t=this.getOffsetTranslate(),s=e.x+t.translateX,n=e.y+t.translateY;s*=this.scaleX,n*=this.scaleY;var i=s+e.width*this.scaleX,a=n+e.height*this.scaleY;return!(s>this.stage.canvas.width||n>this.stage.canvas.height||0>i||0>a)},this.paintOperations=function(e,t){for(var s=0;s<t.length;s++)t[s](e)},this.findElements=function(e){for(var t=[],s=0;s<this.childs.length;s++)!0===e(this.childs[s])&&t.push(this.childs[s]);return t},this.getElementsByClass=function(e){return this.findElements(function(t){return t.elementType===e.elementType||t instanceof e})},this.addOperation=function(e){return this.operations.push(e),this},this.clearOperations=function(){return this.operations=[],this},this.getElementByXY=function(e,t){for(var s=null,n=this.zIndexArray.length-1;n>=0;n--)for(var i=this.zIndexArray[n],a=this.zIndexMap[i],r=a.length-1;r>=0;r--){var h=a[r];if(h instanceof InteractiveElement&&this.isVisiable(h)&&h.isInBound(e,t))return s=h}return s},this.add=function(e){this.childs.push(e),null==this.zIndexMap[e.zIndex]&&(this.zIndexMap[e.zIndex]=[],this.zIndexArray.push(e.zIndex),this.zIndexArray.sort(function(e,t){return e-t})),this.zIndexMap[""+e.zIndex].push(e)},this.remove=function(e){this.childs=Util.removeFromArray(this.childs,e);var t=this.zIndexMap[e.zIndex];t&&(this.zIndexMap[e.zIndex]=Util.removeFromArray(t,e)),e.removeHandler(this)},this.clear=function(){var e=this;this.childs.forEach(function(t){t.removeHandler(e)}),this.childs=[],this.operations=[],this.zIndexArray=[],this.zIndexMap={}},this.addToSelected=function(e){this.selectedElements.push(e)},this.cancleAllSelected=function(e){for(var t=0;t<this.selectedElements.length;t++)this.selectedElements[t].unselectedHandler(e);this.selectedElements=[]},this.notInSelectedNodes=function(e){for(var t=0;t<this.selectedElements.length;t++)if(e===this.selectedElements[t])return!1;return!0},this.removeFromSelected=function(e){for(var t=0;t<this.selectedElements.length;t++){var s=this.selectedElements[t];e===s&&(this.selectedElements=this.selectedElements.del(t))}},this.toSceneEvent=function(e){var t=Util.clone(e);if(t.x/=this.scaleX,t.y/=this.scaleY,1==this.translate){var s=this.getOffsetTranslate();t.x-=s.translateX,t.y-=s.translateY}return null!=t.dx&&(t.dx/=this.scaleX,t.dy/=this.scaleY),null!=this.currentElement&&(t.target=this.currentElement),t.scene=this,t},this.selectElement=function(e){var t=s.getElementByXY(e.x,e.y);if(null!=t)if(e.target=t,t.mousedownHander(e),t.selectedHandler(e),s.notInSelectedNodes(t))e.ctrlKey||s.cancleAllSelected(),s.addToSelected(t);else{1==e.ctrlKey&&(t.unselectedHandler(),this.removeFromSelected(t));for(var n=0;n<this.selectedElements.length;n++){var i=this.selectedElements[n];i.selectedHandler(e)}}else e.ctrlKey||s.cancleAllSelected();this.currentElement=t},this.mousedownHandler=function(e){var t=this.toSceneEvent(e);if(this.mouseDown=!0,this.mouseDownX=t.x,this.mouseDownY=t.y,this.mouseDownEvent=t,this.mode==SceneMode.normal)this.selectElement(t),(null==this.currentElement||this.currentElement instanceof Link)&&1==this.translate&&(this.lastTranslateX=this.translateX,this.lastTranslateY=this.translateY);else{if(this.mode==SceneMode.drag&&1==this.translate)return this.lastTranslateX=this.translateX,void(this.lastTranslateY=this.translateY);this.mode==SceneMode.select?this.selectElement(t):this.mode==SceneMode.edit&&(this.selectElement(t),(null==this.currentElement||this.currentElement instanceof Link)&&1==this.translate&&(this.lastTranslateX=this.translateX,this.lastTranslateY=this.translateY))}s.dispatchEvent("mousedown",t)},this.mouseupHandler=function(e){this.stage.cursor!=MouseCursor.normal&&(this.stage.cursor=MouseCursor.normal),s.clearOperations();var t=this.toSceneEvent(e);null!=this.currentElement&&(t.target=s.currentElement,this.currentElement.mouseupHandler(t)),this.dispatchEvent("mouseup",t),this.mouseDown=!1},this.dragElements=function(e){if(null!=this.currentElement&&1==this.currentElement.dragable)for(var t=0;t<this.selectedElements.length;t++){var s=this.selectedElements[t];if(0!=s.dragable){var n=Util.clone(e);n.target=s,s.mousedragHandler(n)}}},this.mousedragHandler=function(e){var t=this.toSceneEvent(e);this.mode==SceneMode.normal?null==this.currentElement||this.currentElement instanceof Link?1==this.translate&&(this.stage.cursor=MouseCursor.closed_hand,this.translateX=this.lastTranslateX+t.dx,this.translateY=this.lastTranslateY+t.dy):this.dragElements(t):this.mode==SceneMode.drag?1==this.translate&&(this.stage.cursor=MouseCursor.closed_hand,this.translateX=this.lastTranslateX+t.dx,this.translateY=this.lastTranslateY+t.dy):this.mode==SceneMode.select?null!=this.currentElement?1==this.currentElement.dragable&&this.dragElements(t):1==this.areaSelect&&this.areaSelectHandle(t):this.mode==SceneMode.edit&&(null==this.currentElement||this.currentElement instanceof Link?1==this.translate&&(this.stage.cursor=MouseCursor.closed_hand,this.translateX=this.lastTranslateX+t.dx,this.translateY=this.lastTranslateY+t.dy):this.dragElements(t)),this.dispatchEvent("mousedrag",t)},this.areaSelectHandle=function(e){var n=e.offsetLeft,i=e.offsetTop,a=this.mouseDownEvent.offsetLeft,r=this.mouseDownEvent.offsetTop,h=n>=a?a:n,l=i>=r?r:i,o=Math.abs(e.dx)*this.scaleX,c=Math.abs(e.dy)*this.scaleY,u=new t(h,l,o,c);s.clearOperations().addOperation(u),n=e.x,i=e.y,a=this.mouseDownEvent.x,r=this.mouseDownEvent.y,h=n>=a?a:n,l=i>=r?r:i,o=Math.abs(e.dx),c=Math.abs(e.dy);for(var d=h+o,m=l+c,v=0;v<s.childs.length;v++){var f=s.childs[v];f.x>h&&f.x+f.width<d&&f.y>l&&f.y+f.height<m&&s.notInSelectedNodes(f)&&(f.selectedHandler(e),s.addToSelected(f))}},this.mousemoveHandler=function(e){this.mousecoord={x:e.x,y:e.y};var t=this.toSceneEvent(e);if(this.mode==SceneMode.drag)return void(this.stage.cursor=MouseCursor.open_hand);this.mode==SceneMode.normal?this.stage.cursor=MouseCursor.normal:this.mode==SceneMode.select&&(this.stage.cursor=MouseCursor.normal);var n=s.getElementByXY(t.x,t.y);null!=n?(s.mouseOverelement&&s.mouseOverelement!==n&&(t.target=n,s.mouseOverelement.mouseoutHandler(t)),s.mouseOverelement=n,0==n.isMouseOver?(t.target=n,n.mouseoverHandler(t),s.dispatchEvent("mouseover",t)):(t.target=n,n.mousemoveHandler(t),s.dispatchEvent("mousemove",t))):s.mouseOverelement?(t.target=n,s.mouseOverelement.mouseoutHandler(t),s.mouseOverelement=null,s.dispatchEvent("mouseout",t)):(t.target=null,s.dispatchEvent("mousemove",t))},this.mouseoverHandler=function(e){var t=this.toSceneEvent(e);this.dispatchEvent("mouseover",t)},this.mouseoutHandler=function(e){var t=this.toSceneEvent(e);this.dispatchEvent("mouseout",t)},this.clickHandler=function(e){var t=this.toSceneEvent(e);this.currentElement&&(t.target=this.currentElement,this.currentElement.clickHandler(t)),this.dispatchEvent("click",t)},this.dbclickHandler=function(e){var t=this.toSceneEvent(e);this.currentElement?(t.target=this.currentElement,this.currentElement.dbclickHandler(t)):s.cancleAllSelected(),this.dispatchEvent("dbclick",t)},this.mousewheelHandler=function(e){var t=this.toSceneEvent(e);this.dispatchEvent("mousewheel",t)},this.touchstart=this.mousedownHander,this.touchmove=this.mousedragHandler,this.touchend=this.mousedownHander,this.keydownHandler=function(e){this.dispatchEvent("keydown",e)},this.keyupHandler=function(e){this.dispatchEvent("keyup",e)},this.addEventListener=function(e,t){var s=this,n=function(e){t.call(s,e)};return this.messageBus.subscribe(e,n),this},this.removeEventListener=function(e){this.messageBus.unsubscribe(e)},this.removeAllEventListener=function(){this.messageBus=new Util.MessageBus},this.dispatchEvent=function(e,t){return this.messageBus.publish(e,t),this};var n="click,dbclick,mousedown,mouseup,mouseover,mouseout,mousemove,mousedrag,mousewheel,touchstart,touchmove,touchend,keydown,keyup".split(","),i=this;return n.forEach(function(e){i[e]=function(t){null!=t?this.addEventListener(e,t):this.dispatchEvent(e)}}),this.zoom=function(e,t){null!=e&&0!=e&&(this.scaleX=e),null!=t&&0!=t&&(this.scaleY=t)},this.zoomOut=function(e){0!=e&&(null==e&&(e=.8),this.scaleX/=e,this.scaleY/=e)},this.zoomIn=function(e){0!=e&&(null==e&&(e=.8),this.scaleX*=e,this.scaleY*=e)},this.getBound=function(){return{left:0,top:0,right:this.stage.canvas.width,bottom:this.stage.canvas.height,width:this.stage.canvas.width,height:this.stage.canvas.height}},this.getElementsBound=function(){return Util.getElementsBound(this.childs)},this.translateToCenter=function(e){var t=this.getElementsBound(),s=this.stage.canvas.width/2-(t.left+t.right)/2,n=this.stage.canvas.height/2-(t.top+t.bottom)/2;e&&(s=e.canvas.width/2-(t.left+t.right)/2,n=e.canvas.height/2-(t.top+t.bottom)/2),this.translateX=s,this.translateY=n},this.setCenter=function(e,t){var s=e-this.stage.canvas.width/2,n=t-this.stage.canvas.height/2;this.translateX=-s,this.translateY=-n},this.centerAndZoom=function(e,t,s){if(this.translateToCenter(s),null==e||null==t){var n=this.getElementsBound(),i=n.right-n.left,a=n.bottom-n.top,r=this.stage.canvas.width/i,h=this.stage.canvas.height/a;s&&(r=s.canvas.width/i,h=s.canvas.height/a);var l=Math.min(r,h);if(l>1)return;this.zoom(l,l)}this.zoom(e,t)},this.getCenterLocation=function(){return{x:s.stage.canvas.width/2,y:s.stage.canvas.height/2}},this.doLayout=function(e){e&&e(this,this.childs)},this.toJson=function(){var e=this,t="{";this.serializedProperties.length,this.serializedProperties.forEach(function(s){var n=e[s];"background"==s&&(n=e._background.src),"string"==typeof n&&(n='"'+n+'"'),t+='"'+s+'":'+n+","}),t+='"childs":[';var s=this.childs.length;return this.childs.forEach(function(e,n){t+=e.toJson(),s>n+1&&(t+=",")}),t+="]",t+="}"},s}var _defineProperties=require("babel-runtime/core-js/object/define-properties"),_defineProperties2=_interopRequireDefault(_defineProperties),Element=require("./_absElement"),_e=require("./_baseElement"),_l=require("./_link"),_n=require("./_node"),Tobj=require("./_tobj"),Util=require("./_util"),SceneMode=Tobj.SceneMode,MouseCursor=Tobj.MouseCursor,Link=_l.Link,Node=_n.Node,InteractiveElement=_e.InteractiveElement;Scene.prototype=new Element;var imageCache={};(0,_defineProperties2.default)(Scene.prototype,{background:{get:function(){return this._background},set:function(e){var t=this;"string"==typeof e?!function(){var s=imageCache[e];null==s&&(s=new Image,s.src=e,s.onload=function(){imageCache[e]=s}),t._background=s}():this._background=e}}}),module.exports=Scene;