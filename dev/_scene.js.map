{"version":3,"sources":["../src/_scene.js"],"names":["Element","require","_e","_l","_n","Tobj","Util","SceneMode","MouseCursor","Link","Node","InteractiveElement","Scene","stage","createRect","x","y","width","height","ctx","beginPath","strokeStyle","fillStyle","rect","fill","stroke","closePath","_self","initialize","prototype","apply","arguments","messageBus","MessageBus","elementType","childs","zIndexMap","zIndexArray","backgroundColor","visible","alpha","scaleX","scaleY","mode","normal","translate","translateX","translateY","lastTranslateX","lastTranslateY","mouseDown","mouseDownX","mouseDownY","mouseDownEvent","areaSelect","operations","selectedElements","paintAll","properties","split","serializedProperties","concat","setBackground","bg","background","addTo","st","add","show","hide","paint","save","paintBackgroud","restore","scale","offT","getOffsetTranslate","paintChilds","paintOperations","repaint","drawImage","canvas","fillRect","getDisplayedElements","eles","i","length","temp","maps","j","ele","isVisiable","push","getDisplayedNodes","nodeArray","zIarr","value","transformAble","h","getCenterLocation","rotate","shadow","shadowBlur","shadowColor","shadowOffsetX","shadowOffsetY","selected","showSelected","paintSelected","isMouseOver","paintMouseover","scW","scH","valX","valY","offObj","offTrans","calcX","calcY","_width","_height","ops","findElements","filterFn","eleResults","getElementsByClass","targetEle","addOperation","opFn","clearOperations","getElementByXY","eleX","eleY","eleResult","val","eleTemp","isInBound","eleObj","zIndex","sort","a","b","remove","removeFromArray","removeHandler","clear","_tempSelf","forEach","tempEle","addToSelected","cancleAllSelected","unselectedHandler","notInSelectedNodes","removeFromSelected","selectObj","del","toSceneEvent","ev","event","clone","dx","dy","currentElement","target","scene","selectElement","mousedownHander","selectedHandler","ctrlKey","selectEle","mousedownHandler","tempEvent","drag","select","edit","dispatchEvent","mouseupHandler","cursor","dragElements","dragable","mousedragHandler","closed_hand","areaSelectHandle","offL","offsetLeft","offsetTop","deOffL","deOffTop","targetOffL","targetOffT","tarScaleX","Math","abs","tarScaleY","targetRect","childItem","mousemoveHandler","mousecoord","c","open_hand","d","mouseOverelement","mouseoutHandler","mouseoverHandler","clickHandler","dbclickHandler","mousewheelHandler","touchstart","touchmove","touchend","keydownHandler","keyupHandler","addEventListener","call","subscribe","removeEventListener","unsubscribe","removeAllEventListener","publish","events","tempSelf","zoom","zoomOut","zoomIn","getBound","left","top","right","bottom","getElementsBound","translateToCenter","setCenter","centerAndZoom","e","f","g","min","doLayout","toJson","item","_background","src","imageCache","Object","defineProperties","get","set","imgUrl","img","Image","onload","module","exports"],"mappings":"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","file":"_scene.js","sourcesContent":["//////////////////////////////\n/**\n * scene\n * 画布\n * @author ilex\n * @description 2016-11-04 11:56:12\n */\n//////////////////////////////\nconst Element = require('./_absElement');\nconst _e = require('./_baseElement');\nconst _l = require('./_link');\nconst _n = require('./_node');\nconst Tobj = require('./_tobj');\nconst Util = require('./_util');\nconst SceneMode = Tobj.SceneMode;\nconst MouseCursor = Tobj.MouseCursor;\n\nconst Link = _l.Link;\nconst Node = _n.Node;\nconst InteractiveElement = _e.InteractiveElement;\n/**\n * 画布\n *\n * @param {any} stage 所属stage舞台\n * @returns\n */\nfunction Scene(stage) {\n  /**\n   * 创建矩形\n   *\n   * @param {any} x\n   * @param {any} y\n   * @param {any} width\n   * @param {any} height\n   * @returns\n   */\n  function createRect(x,y,width,height) {\n    return function(ctx) {\n      ctx.beginPath(),\n        ctx.strokeStyle = 'rgba(0,0,236,0.5)',\n        ctx.fillStyle = 'rgba(0,0,236,0.1)',\n        ctx.rect(x,y,width,height),\n        ctx.fill(),\n        ctx.stroke(),\n        ctx.closePath();\n    };\n  }\n  let _self = this;\n  this.initialize = function() {\n    Scene.prototype.initialize.apply(this, arguments),\n      this.messageBus = new Util.MessageBus,\n      this.elementType = 'scene',\n      this.childs = [],\n      this.zIndexMap = {},\n      this.zIndexArray = [],\n      this.backgroundColor = '255,255,255',\n      this.visible = true,\n      this.alpha = 0,\n      this.scaleX = 1,\n      this.scaleY = 1,\n      this.mode = SceneMode.normal,\n      this.translate = true,\n      this.translateX = 0,\n      this.translateY = 0,\n      this.lastTranslateX = 0,\n      this.lastTranslateY = 0,\n      this.mouseDown = false,\n      this.mouseDownX = null,\n      this.mouseDownY = null,\n      this.mouseDownEvent = null,\n      this.areaSelect = true,\n      this.operations = [],\n      this.selectedElements = [],\n      this.paintAll = false;\n    let properties = 'background,backgroundColor,mode,paintAll,areaSelect,translate,translateX,translateY,lastTranslatedX,lastTranslatedY,alpha,visible,scaleX,scaleY'.split(',');\n    this.serializedProperties = this.serializedProperties.concat(properties);\n  },\n  this.initialize(),\n  this.setBackground = function(bg) {\n    this.background = bg;\n  },\n  this.addTo = function(st) {\n    this.stage !== st && null != st && (this.stage = st);\n  },\n  null != stage && (stage.add(this), this.addTo(stage)),\n  this.show = function() {\n    this.visible = true;\n  },\n  this.hide = function() {\n    this.visible = false;\n  },\n  this.paint = function(ctx) {\n    if (0 != this.visible && null != this.stage) {\n      ctx.save(),\n        this.paintBackgroud(ctx),\n        ctx.restore(),\n        ctx.save(),\n        ctx.scale(this.scaleX, this.scaleY);\n      if (1 == this.translate) {\n        let offT = this.getOffsetTranslate(ctx);\n        ctx.translate(offT.translateX, offT.translateY);\n      }\n      this.paintChilds(ctx),\n        ctx.restore(),\n        ctx.save(),\n        this.paintOperations(ctx, this.operations),\n        ctx.restore();\n    }\n  },\n  this.repaint = function(ctx) {\n    false !== this.visible && this.paint(ctx);\n  },\n  this.paintBackgroud = function(ctx) {\n    if(null != this.background){\n      ctx.drawImage(this.background, 0, 0, ctx.canvas.width, ctx.canvas.height);\n    }else{\n      ctx.beginPath(),\n      ctx.fillStyle = 'rgba(' + this.backgroundColor + ',' + this.alpha + ')',\n      ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height),\n      ctx.closePath();\n    }\n  },\n  this.getDisplayedElements = function() {\n    let eles = [];\n    for (let i = 0; i < this.zIndexArray.length; i++) {\n      let temp = this.zIndexArray[i];\n      let maps = this.zIndexMap[temp];\n      for (let j = 0; j < maps.length; j++) {\n        let ele = maps[j];\n        this.isVisiable(ele) && eles.push(ele);\n      }\n    }\n    return eles;\n  },\n  this.getDisplayedNodes = function() {\n    let nodeArray = [];\n    for (let i = 0; i < this.childs.length; i++) {\n      let ele = this.childs[i];\n      ele instanceof Node && this.isVisiable(ele) && nodeArray.push(ele);\n      // ele.elementType === 'node' && this.isVisiable(ele) && nodeArray.push(ele);\n    }\n    return nodeArray;\n  },\n  this.paintChilds = function(ctx) {\n    for (let i = 0; i < this.zIndexArray.length; i++) {\n      let zIarr = this.zIndexArray[i], value = this.zIndexMap[zIarr];\n      for (let j = 0; j < value.length; j++) {\n        let ele = value[j];\n        if (true === this.paintAll || this.isVisiable(ele)) {\n          ctx.save();\n          if (true === ele.transformAble) {\n            let h = ele.getCenterLocation();\n            ctx.translate(h.x, h.y),\n              ele.rotate && ctx.rotate(ele.rotate),\n              ele.scaleX && ele.scaleY ? ctx.scale(ele.scaleX, ele.scaleY) : ele.scaleX ? ctx.scale(ele.scaleX, 1) : ele.scaleY && ctx.scale(1, ele.scaleY);\n          }\n          if(true === ele.shadow){\n            ctx.shadowBlur = ele.shadowBlur, ctx.shadowColor = ele.shadowColor, ctx.shadowOffsetX = ele.shadowOffsetX, ctx.shadowOffsetY = ele.shadowOffsetY;\n          }\n          if(ele instanceof InteractiveElement){\n            if(ele.selected && true === ele.showSelected){\n              ele.paintSelected(ctx);\n            }\n            if(true === ele.isMouseOver){\n              ele.paintMouseover(ctx);\n            }\n          }\n          ele.paint(ctx);\n          ctx.restore();\n        }\n      }\n    }\n  },\n  this.getOffsetTranslate = function(ctx) {\n    let scW = this.stage.canvas.width,\n      scH = this.stage.canvas.height;\n    null != ctx && 'move' != ctx && (scW = ctx.canvas.width, scH = ctx.canvas.height);\n    let valX = scW / this.scaleX / 2,\n      valY = scH / this.scaleY / 2,\n      offObj = {\n        translateX: this.translateX + (valX - valX * this.scaleX),\n        translateY: this.translateY + (valY - valY * this.scaleY)\n      };\n    return offObj;\n  },\n  this.isVisiable = function(ele) {\n    if (true !== ele.visible) {return false;}\n    if (ele instanceof Link) {return true;}\n    // if (ele.elementType === 'link') {return true;}\n    let offTrans = this.getOffsetTranslate(),\n      calcX = ele.x + offTrans.translateX,\n      calcY = ele.y + offTrans.translateY;\n    calcX *= this.scaleX,\n      calcY *= this.scaleY;\n    let _width = calcX + ele.width * this.scaleX,\n      _height = calcY + ele.height * this.scaleY;\n    return calcX > this.stage.canvas.width || calcY > this.stage.canvas.height || 0 > _width || 0 > _height ? false : true;\n  },\n  /**\n   * 绘制操作\n   * @param {any} ctx context\n   * @param {array} canvas操作\n   */\n  this.paintOperations = function(ctx, ops) {\n    for (let i = 0; i < ops.length; i++) {\n      ops[i](ctx);\n    }\n  },\n  this.findElements = function(filterFn) {\n    let eleResults = [];\n    for (let i = 0; i < this.childs.length; i++) {\n      true === filterFn(this.childs[i]) && eleResults.push(this.childs[i]);\n    }\n    return eleResults;\n  },\n  /**\n   * 获取符合指定类型的所有元素\n   * @param {any} targetEle 指定的元素类型\n  */\n  this.getElementsByClass = function(targetEle) {\n    return this.findElements(function(ele) {\n      return ele.elementType === targetEle.elementType || ele instanceof targetEle;\n    });\n  },\n  this.addOperation = function(opFn) {\n    return this.operations.push(opFn),\n      this;\n  },\n  this.clearOperations = function() {\n    return this.operations = [],\n      this;\n  },\n  this.getElementByXY = function(eleX, eleY) {\n    let eleResult = null;\n    for (let i = this.zIndexArray.length - 1; i >= 0; i--) {\n      let temp = this.zIndexArray[i], val = this.zIndexMap[temp];\n      for (let j = val.length - 1; j >= 0; j--) {\n        let eleTemp = val[j];\n        if (eleTemp instanceof InteractiveElement && this.isVisiable(eleTemp) && eleTemp.isInBound(eleX, eleY)) {\n          return eleResult = eleTemp;\n        }\n      }\n    }\n    return eleResult;\n  },\n  this.add = function(eleObj) {\n    this.childs.push(eleObj),\n      null == this.zIndexMap[eleObj.zIndex] && (this.zIndexMap[eleObj.zIndex] = [], this.zIndexArray.push(eleObj.zIndex), this.zIndexArray.sort(function(a, b) {\n        return a - b;\n      })),\n      this.zIndexMap['' + eleObj.zIndex].push(eleObj);\n  },\n  /**\n   * 清除元素\n   * @param {any} eleObj 要被清除的元素\n   */\n  this.remove = function(eleObj) {\n    this.childs = Util.removeFromArray(this.childs, eleObj);\n    let val = this.zIndexMap[eleObj.zIndex];\n    val && (this.zIndexMap[eleObj.zIndex] = Util.removeFromArray(val, eleObj)),\n      eleObj.removeHandler(this);\n  },\n  /**\n   * 清空画布中的所有元素\n   * @param {any} eleObj 要被清除的元素\n   */\n  this.clear = function() {\n    let _tempSelf = this;\n    this.childs.forEach(function(tempEle) {\n      tempEle.removeHandler(_tempSelf);\n    }),\n      this.childs = [],\n      this.operations = [],\n      this.zIndexArray = [],\n      this.zIndexMap = {};\n  },\n  this.addToSelected = function(eleObj) {\n    this.selectedElements.push(eleObj);\n  },\n  /**\n   * 取消所有选中\n   * @param {any} eleObj\n   */\n  this.cancleAllSelected = function(eleObj) {\n    for (let i = 0; i < this.selectedElements.length; i++) {\n      this.selectedElements[i].unselectedHandler(eleObj);\n    }\n    this.selectedElements = [];\n  },\n  this.notInSelectedNodes = function(eleObj) {\n    for (let i = 0; i < this.selectedElements.length; i++) {\n      if (eleObj === this.selectedElements[i]) {\n        return false;\n      }\n    }\n    return true;\n  },\n  /**\n   * 删除所有选中\n   * @param {any} eleObj\n   */\n  this.removeFromSelected = function(eleObj) {\n    for (let i = 0; i < this.selectedElements.length; i++) {\n      let selectObj = this.selectedElements[i];\n      eleObj === selectObj && (this.selectedElements = this.selectedElements.del(i));\n    }\n  },\n  this.toSceneEvent = function(ev) {\n    let event = Util.clone(ev);\n    event.x /= this.scaleX;\n    event.y /= this.scaleY;\n    if (1 == this.translate) {\n      let offTrans = this.getOffsetTranslate();\n      event.x -= offTrans.translateX,\n        event.y -= offTrans.translateY;\n    }\n    return null != event.dx && (event.dx /= this.scaleX, event.dy /= this.scaleY),\n      null != this.currentElement && (event.target = this.currentElement),\n      event.scene = this,\n      event;\n  },\n  this.selectElement = function(ev) {\n    let targetEle = _self.getElementByXY(ev.x, ev.y);\n    if (null != targetEle) {\n      ev.target = targetEle, targetEle.mousedownHander(ev), targetEle.selectedHandler(ev);\n      if (_self.notInSelectedNodes(targetEle)) {\n        ev.ctrlKey || _self.cancleAllSelected(),\n        _self.addToSelected(targetEle);\n      } else {\n        1 == ev.ctrlKey && (targetEle.unselectedHandler(), this.removeFromSelected(targetEle));\n        for (let i = 0; i < this.selectedElements.length; i++) {\n          let selectEle = this.selectedElements[i];\n          selectEle.selectedHandler(ev);\n        }\n      }\n    } else {\n      ev.ctrlKey || _self.cancleAllSelected();\n    }\n    this.currentElement = targetEle;\n  },\n  this.mousedownHandler = function(ev) {\n    let tempEvent = this.toSceneEvent(ev);\n    this.mouseDown = true,\n      this.mouseDownX = tempEvent.x,\n      this.mouseDownY = tempEvent.y,\n      this.mouseDownEvent = tempEvent;\n    if (this.mode == SceneMode.normal) {\n      this.selectElement(tempEvent),\n      (null == this.currentElement || this.currentElement instanceof Link) && 1 == this.translate && (this.lastTranslateX = this.translateX, this.lastTranslateY = this.translateY);\n    }\n    else {\n      if (this.mode == SceneMode.drag && 1 == this.translate) {\n        return this.lastTranslateX = this.translateX, void (this.lastTranslateY = this.translateY);\n      }\n      this.mode == SceneMode.select ? this.selectElement(tempEvent) : this.mode == SceneMode.edit && (this.selectElement(tempEvent), (null == this.currentElement || this.currentElement instanceof Link) && 1 == this.translate && (this.lastTranslateX = this.translateX, this.lastTranslateY = this.translateY));\n    }\n    _self.dispatchEvent('mousedown', tempEvent);\n  },\n  this.mouseupHandler = function(ev) {\n    this.stage.cursor != MouseCursor.normal && (this.stage.cursor = MouseCursor.normal),\n      _self.clearOperations();\n    let tempEvent = this.toSceneEvent(ev);\n    null != this.currentElement && (tempEvent.target = _self.currentElement, this.currentElement.mouseupHandler(tempEvent)),\n      this.dispatchEvent('mouseup', tempEvent),\n      this.mouseDown = false;\n  },\n  this.dragElements = function(ev) {\n    if (null != this.currentElement && 1 == this.currentElement.dragable) {\n      for (let i = 0; i < this.selectedElements.length; i++) {\n        let tempEle = this.selectedElements[i];\n        if (0 != tempEle.dragable) {\n          let tempEvent = Util.clone(ev);\n          tempEvent.target = tempEle,\n          tempEle.mousedragHandler(tempEvent);\n        }\n      }}\n  },\n  this.mousedragHandler = function(ev) {\n    let tempEvent = this.toSceneEvent(ev);\n    this.mode == SceneMode.normal ? null == this.currentElement || this.currentElement instanceof Link ?\n    1 == this.translate && (this.stage.cursor = MouseCursor.closed_hand, this.translateX = this.lastTranslateX + tempEvent.dx, this.translateY = this.lastTranslateY + tempEvent.dy)\n    :this.dragElements(tempEvent) : this.mode == SceneMode.drag ?\n    1 == this.translate && (this.stage.cursor = MouseCursor.closed_hand, this.translateX = this.lastTranslateX + tempEvent.dx, this.translateY = this.lastTranslateY + tempEvent.dy)\n    : this.mode == SceneMode.select ? null != this.currentElement ? 1 == this.currentElement.dragable && this.dragElements(tempEvent) : 1 == this.areaSelect && this.areaSelectHandle(tempEvent)\n    : this.mode == SceneMode.edit && (null == this.currentElement || this.currentElement instanceof Link ?\n    1 == this.translate && (this.stage.cursor = MouseCursor.closed_hand, this.translateX = this.lastTranslateX + tempEvent.dx, this.translateY = this.lastTranslateY + tempEvent.dy)\n    : this.dragElements(tempEvent)),\n      this.dispatchEvent('mousedrag', tempEvent);\n  },\n  this.areaSelectHandle = function(ev) {\n    let offL = ev.offsetLeft,\n      offT = ev.offsetTop,\n      deOffL = this.mouseDownEvent.offsetLeft,\n      deOffTop = this.mouseDownEvent.offsetTop,\n      targetOffL = offL >= deOffL ? deOffL : offL,\n      targetOffT = offT >= deOffTop ? deOffTop : offT,\n      tarScaleX = Math.abs(ev.dx) * this.scaleX,\n      tarScaleY = Math.abs(ev.dy) * this.scaleY,\n      targetRect = new createRect(targetOffL, targetOffT, tarScaleX, tarScaleY);\n    _self.clearOperations().addOperation(targetRect),\n      offL = ev.x,\n      offT = ev.y,\n      deOffL = this.mouseDownEvent.x,\n      deOffTop = this.mouseDownEvent.y,\n      targetOffL = offL >= deOffL ? deOffL : offL,\n      targetOffT = offT >= deOffTop ? deOffTop : offT,\n      tarScaleX = Math.abs(ev.dx),\n      tarScaleY = Math.abs(ev.dy);\n    let _width = targetOffL + tarScaleX, _height = targetOffT + tarScaleY;\n    for (let i = 0; i < _self.childs.length; i++) {\n      let childItem = _self.childs[i];\n      childItem.x > targetOffL && childItem.x + childItem.width < _width && childItem.y > targetOffT && childItem.y + childItem.height < _height && _self.notInSelectedNodes(childItem) && (childItem.selectedHandler(ev), _self.addToSelected(childItem));\n    }\n  },\n  this.mousemoveHandler = function(ev) {\n    this.mousecoord = {\n      x: ev.x,\n      y: ev.y\n    };\n    let c = this.toSceneEvent(ev);\n    if (this.mode == SceneMode.drag) {return void (this.stage.cursor = MouseCursor.open_hand);}\n    this.mode == SceneMode.normal ? this.stage.cursor = MouseCursor.normal : this.mode == SceneMode.select && (this.stage.cursor = MouseCursor.normal);\n    let d = _self.getElementByXY(c.x, c.y);\n    null != d ? (_self.mouseOverelement && _self.mouseOverelement !== d && (c.target = d, _self.mouseOverelement.mouseoutHandler(c)), _self.mouseOverelement = d, 0 == d.isMouseOver ? (c.target = d, d.mouseoverHandler(c), _self.dispatchEvent('mouseover', c)) : (c.target = d, d.mousemoveHandler(c), _self.dispatchEvent('mousemove', c))) : _self.mouseOverelement ? (c.target = d, _self.mouseOverelement.mouseoutHandler(c), _self.mouseOverelement = null, _self.dispatchEvent('mouseout', c)) : (c.target = null, _self.dispatchEvent('mousemove', c));\n  },\n  this.mouseoverHandler = function(ev) {\n    let b = this.toSceneEvent(ev);\n    this.dispatchEvent('mouseover', b);\n  },\n  this.mouseoutHandler = function(ev) {\n    let b = this.toSceneEvent(ev);\n    this.dispatchEvent('mouseout', b);\n  },\n  this.clickHandler = function(ev) {\n    let b = this.toSceneEvent(ev);\n    this.currentElement && (b.target = this.currentElement, this.currentElement.clickHandler(b)),\n      this.dispatchEvent('click', b);\n  },\n  this.dbclickHandler = function(ev) {\n    let b = this.toSceneEvent(ev);\n    this.currentElement ? (b.target = this.currentElement, this.currentElement.dbclickHandler(b)) : _self.cancleAllSelected(),\n      this.dispatchEvent('dbclick', b);\n  },\n  this.mousewheelHandler = function(ev) {\n    let b = this.toSceneEvent(ev);\n    this.dispatchEvent('mousewheel', b);\n  },\n  this.touchstart = this.mousedownHander,\n  this.touchmove = this.mousedragHandler,\n  this.touchend = this.mousedownHander,\n  this.keydownHandler = function(a) {\n    this.dispatchEvent('keydown', a);\n  },\n  this.keyupHandler = function(a) {\n    this.dispatchEvent('keyup', a);\n  },\n  this.addEventListener = function(a, b) {\n    let c = this,\n      d = function(a) {\n        b.call(c, a);\n      };\n    return this.messageBus.subscribe(a, d),\n      this;\n  },\n  this.removeEventListener = function(a) {\n    this.messageBus.unsubscribe(a);\n  },\n  this.removeAllEventListener = function() {\n    this.messageBus = new Util.MessageBus;\n  },\n  this.dispatchEvent = function(a, b) {\n    return this.messageBus.publish(a, b),\n      this;\n  };\n  let events = 'click,dbclick,mousedown,mouseup,mouseover,mouseout,mousemove,mousedrag,mousewheel,touchstart,touchmove,touchend,keydown,keyup'.split(','),\n    tempSelf = this;\n  return events.forEach(function(a) {\n    tempSelf[a] = function(b) {\n      null != b ? this.addEventListener(a, b) : this.dispatchEvent(a);\n    };\n  }),\n  this.zoom = function(a, b) {\n    null != a && 0 != a && (this.scaleX = a),\n      null != b && 0 != b && (this.scaleY = b);\n  },\n  this.zoomOut = function(a) {\n    0 != a && (null == a && (a = .8), this.scaleX /= a, this.scaleY /= a);\n  },\n  this.zoomIn = function(a) {\n    0 != a && (null == a && (a = .8), this.scaleX *= a, this.scaleY *= a);\n  },\n  this.getBound = function() {\n    return {\n      left: 0,\n      top: 0,\n      right: this.stage.canvas.width,\n      bottom: this.stage.canvas.height,\n      width: this.stage.canvas.width,\n      height: this.stage.canvas.height\n    };\n  },\n  this.getElementsBound = function() {\n    return Util.getElementsBound(this.childs);\n  },\n  this.translateToCenter = function(a) {\n    let b = this.getElementsBound(),\n      c = this.stage.canvas.width / 2 - (b.left + b.right) / 2,\n      d = this.stage.canvas.height / 2 - (b.top + b.bottom) / 2;\n    a && (c = a.canvas.width / 2 - (b.left + b.right) / 2, d = a.canvas.height / 2 - (b.top + b.bottom) / 2),\n      this.translateX = c,\n      this.translateY = d;\n  },\n  this.setCenter = function(a, b) {\n    let c = a - this.stage.canvas.width / 2,\n      d = b - this.stage.canvas.height / 2;\n    this.translateX = -c,\n      this.translateY = -d;\n  },\n  this.centerAndZoom = function(a, b, c) {\n    if (this.translateToCenter(c), null == a || null == b) {\n      let d = this.getElementsBound(),\n        e = d.right - d.left,\n        f = d.bottom - d.top,\n        g = this.stage.canvas.width / e,\n        h = this.stage.canvas.height / f;\n      c && (g = c.canvas.width / e, h = c.canvas.height / f);\n      let i = Math.min(g, h);\n      if (i > 1) {return;}\n      this.zoom(i, i);\n    }\n    this.zoom(a, b);\n  },\n  this.getCenterLocation = function() {\n    return {\n      x: _self.stage.canvas.width / 2,\n      y: _self.stage.canvas.height / 2\n    };\n  },\n  this.doLayout = function(a) {\n    a && a(this, this.childs);\n  },\n  this.toJson = function() {\n    {\n      var a = this,\n        b = '{';\n      this.serializedProperties.length;\n    }\n    this.serializedProperties.forEach(function(c) {\n      var item = a[c];\n      'background' == c && (item = a._background.src),\n        'string' == typeof item && (item = '\"' + item + '\"'),\n        b += '\"' + c + '\":' + item + ',';\n    }),\n      b += '\"childs\":[';\n    var c = this.childs.length;\n    return this.childs.forEach(function(a, d) {\n      b += a.toJson(),\n        c > d + 1 && (b += ',');\n    }),\n      b += ']',\n      b += '}';\n  },\n  _self;\n}\n\nScene.prototype = new Element;\nlet imageCache = {};\nObject.defineProperties(Scene.prototype, {\n  background: {\n    get: function() {\n      return this._background;\n    },\n    set: function(imgUrl) {\n      if ('string' == typeof imgUrl) {\n        let img = imageCache[imgUrl];\n        null == img && (img = new Image, img.src = imgUrl, img.onload = function() {\n          imageCache[imgUrl] = img;\n        }),\n          this._background = img;\n      } else {this._background = imgUrl;}\n    }\n  }\n});\n\nmodule.exports = Scene;\n"]}