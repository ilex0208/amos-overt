{"version":3,"sources":["../src/_stage.js"],"names":["Util","require","Tobj","createEagleEye","stageObj","hgap","visible","exportCanvas","document","createElement","getImage","_width","_height","bound","getBound","scalewidth","scaleheight","width","canvas","height","heigh","ctx","getContext","childs","length","save","clearRect","forEach","a","translateX","translateY","scaleX","scaleY","scale","left","Math","abs","top","paintAll","repaint","restore","toDataURL","update","eagleImageDatas","getData","setSize","createTranslate","gdStage","scW","stage","scH","tempX","tempY","limitW","limitH","childStage","centerAndZoom","$translate","trX","trY","lineWidth","strokeStyle","strokeRect","l","getImageData","m","console","log","paint","graphics","fillStyle","fillRect","fill","rect","stroke","putImageData","eventHandler","eventType","eventPos","st","epX","x","epY","y","lastTranslateX","lastTranslateY","epDx","dx","epDy","dy","w_x_w","h_y_h","Stage","$canvas","_self","isContextMenu","isMenuTimeOut","_getEventPosition","ev","evPos","getEventPosition","offPos","getOffsetPosition","offsetLeft","pageX","offsetTop","pageY","target","mouseOver","onselectstart","dispatchEventToScenes","dispatchEvent","mouseOut","setTimeout","needRepaint","animate","mouseDown","mouseDownX","mouseDownY","mouseUp","mouseMove","window","clearTimeout","button","eagleEye","click","dbClick","mouseWheel","wheelZoom","preventDefault","event","returnValue","addEvent","targetDom","isIE","addEventListener","onmouseout","onmouseover","onmousedown","onmouseup","onmousemove","onclick","ondblclick","onmousewheel","touchstart","touchmove","touchend","isFirefox","cloneEvent","code","keyCode","initialize","cans","frames","messageBus","MessageBus","serializedProperties","oncontextmenu","indexOf","c","d","Error","call","add","i","addTo","push","remove","del","clear","evType","fn","callback","msg","subscribe","removeEventListener","unsubscribe","removeAllEventListener","publish","events","split","tempSelf","saveImageInfo","imgData","newPage","open","write","saveAsLocalImage","replace","location","href","item","zoom","wheel","zoomOut","zoomIn","setCenter","_w","_h","cw","ch","Number","MAX_VALUE","right","MIN_VALUE","bottom","eb","getElementsBound","leftNode","topNode","rightNode","bottomNode","toJson","resultJson","version","spItem","spItemValue","stItem","arguments","callee","mousewheel","temp","wheelDelta","detail","isChrome","prototype","cursor","cur","style","mode","modeType","module","exports"],"mappings":"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","file":"_stage.js","sourcesContent":["//////////////////////////////\n/**\n * stage\n * 舞台\n * @author ilex\n * @description 2016-11-05 11:56:12\n */\n//////////////////////////////\nconst Util = require('./_util');\nconst Tobj = require('./_tobj');\n\n/**\n * 鹰眼\n *\n * @param {any} stage\n * @returns\n */\nfunction createEagleEye(stageObj) {\n  return {\n    hgap: 16,\n    visible: false,\n    exportCanvas: document.createElement('canvas'),\n    /**\n     * 获取图片\n     * @param {number} _width\n     * @param {number} _width\n     * @return base64 img\n     */\n    getImage: function(_width, _height) {\n      let bound = stageObj.getBound(),\n        scalewidth = 1, // 缩放当前绘图的宽度 (1=100%, 0.5=50%, 2=200%, 依次类推)\n        scaleheight = 1; // 缩放当前绘图的高度 (1=100%, 0.5=50%, 2=200%, etc.)\n      this.exportCanvas.width = stageObj.canvas.width,\n        this.exportCanvas.height = stageObj.canvas.height;\n      if(null != _width && null != _height){\n        this.exportCanvas.width = _width,\n          this.exportCanvas.height = _height,\n          scalewidth = _width / bound.width,\n          scaleheight = _height / bound.height;\n      }else{\n        if(bound.width > stageObj.canvas.width){\n          this.exportCanvas.width = bound.width;\n        }\n        if(bound.height > stageObj.canvas.height){\n          this.exportCanvas.height = bound.heigh;\n        }\n      }\n      // null != _width && null != _height ?\n      // (this.exportCanvas.width = _width, this.exportCanvas.height = _height, e = _width / bound.width, f = _height / bound.height)\n      // :\n      // (bound.width > stageObj.canvas.width && (this.exportCanvas.width = bound.width), bound.height > stageObj.canvas.height && (this.exportCanvas.height = bound.height));\n      let ctx = this.exportCanvas.getContext('2d');\n      if(stageObj.childs.length > 0){\n        ctx.save(),\n        ctx.clearRect(0, 0, this.exportCanvas.width, this.exportCanvas.height),\n        stageObj.childs.forEach(function(a) {\n          if(1 == stageObj.visible){\n            stageObj.save(),\n            stageObj.translateX = 0,\n            stageObj.translateY = 0,\n            stageObj.scaleX = 1,\n            stageObj.scaleY = 1,\n            ctx.scale(scalewidth, scaleheight);\n            if(bound.left < 0){\n              stageObj.translateX = Math.abs(bound.left);\n            }\n            if(bound.top < 0) {\n              stageObj.translateY = Math.abs(bound.top);\n            }\n            stageObj.paintAll = true,\n            stageObj.repaint(ctx),\n            stageObj.paintAll = false,\n            stageObj.restore();\n          }\n        }),\n        ctx.restore();\n      }\n      return this.exportCanvas.toDataURL('image/png');// base64编码图片\n    },\n    canvas: document.createElement('canvas'),\n    update: function() {\n      this.eagleImageDatas = this.getData(stageObj);\n    },\n    setSize: function(width, height) {\n      this.width = this.canvas.width = width,\n        this.height = this.canvas.height = height;\n    },\n    getData: function(_width, _height) {\n      /**\n       * 创建translate\n       *\n       * @param {any} gdStage 舞台实例\n       * @returns\n       */\n      function createTranslate(gdStage) {\n        let scW = gdStage.stage.canvas.width,\n          scH = gdStage.stage.canvas.height,\n          tempX = scW / gdStage.scaleX / 2,\n          tempY = scH / gdStage.scaleY / 2;\n        return {\n          translateX: gdStage.translateX + tempX - tempX * gdStage.scaleX,\n          translateY: gdStage.translateY + tempY - tempY * gdStage.scaleY\n        };\n      }\n      let ctx = this.canvas.getContext('2d');\n      let limitW, limitH;\n      if (stageObj.childs.length > 0) {\n        ctx.save(),\n          ctx.clearRect(0, 0, this.canvas.width, this.canvas.height),\n          stageObj.childs.forEach(function(childStage) {\n            if(true === childStage.visible){\n              childStage.save(),\n                childStage.centerAndZoom(null, null, ctx),\n                childStage.repaint(ctx),\n                childStage.restore();\n            }\n            // true == childStage.visible && (childStage.save(), childStage.centerAndZoom(null, null, ctx), childStage.repaint(ctx), childStage.restore());\n          });\n        let $translate = createTranslate(stageObj.childs[0]),\n          trX = $translate.translateX * (this.canvas.width / stageObj.canvas.width) * stageObj.childs[0].scaleX,\n          trY = $translate.translateY * (this.canvas.height / stageObj.canvas.height) * stageObj.childs[0].scaleY,\n          bound = stageObj.getBound();\n        limitW = stageObj.canvas.width / stageObj.childs[0].scaleX / bound.width;\n        limitH = stageObj.canvas.height / stageObj.childs[0].scaleY / bound.height;\n        limitW > 1 && (limitW = 1),\n          limitH > 1 && (limitW = 1),\n          trX *= limitW,\n          trY *= limitH,\n          bound.left < 0 && (trX -= Math.abs(bound.left) * (this.width / bound.width)),\n          bound.top < 0 && (trY -= Math.abs(bound.top) * (this.height / bound.height)),\n          ctx.save(),\n          ctx.lineWidth = 1,\n          ctx.strokeStyle = 'rgba(255,0,0,1)',\n          ctx.strokeRect(- trX, -trY, ctx.canvas.width * limitW, ctx.canvas.height * limitH),\n          ctx.restore();\n        let l = null;\n        try {\n          l = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height);\n        } catch (m) { console.log(m); }\n        return l;\n      }\n      null != limitW && null != limitH ? this.setSize(_width, _height) : this.setSize(200, 160);\n      return null;\n    },\n    paint: function() {\n      if (null != this.eagleImageDatas) {\n        let ctx = stageObj.graphics;\n        ctx.save(),\n          ctx.fillStyle = 'rgba(211,211,211,0.3)',\n          ctx.fillRect(stageObj.canvas.width - this.canvas.width - 2 * this.hgap, stageObj.canvas.height - this.canvas.height - 1, stageObj.canvas.width - this.canvas.width, this.canvas.height + 1),\n          ctx.fill(),\n          ctx.save(),\n          ctx.lineWidth = 1,\n          ctx.strokeStyle = 'rgba(0,0,0,1)',\n          ctx.rect(stageObj.canvas.width - this.canvas.width - 2 * this.hgap, stageObj.canvas.height - this.canvas.height - 1, stageObj.canvas.width - this.canvas.width, this.canvas.height + 1),\n          ctx.stroke(),\n          ctx.restore(),\n          ctx.putImageData(this.eagleImageDatas, stageObj.canvas.width - this.canvas.width - this.hgap, stageObj.canvas.height - this.canvas.height),\n          ctx.restore();\n      } else {\n        this.eagleImageDatas = this.getData(stageObj);\n      }\n    },\n    /**\n     * 事件handler\n     * @param {string} eventType\n     * @param {event} eventPos\n     * @param {string} st stage实例\n     */\n    eventHandler: function(eventType, eventPos, st) {\n      let epX = eventPos.x,\n        epY = eventPos.y;\n      if (epX > st.canvas.width - this.canvas.width && epY > st.canvas.height - this.canvas.height) {\n        epX = eventPos.x - this.canvas.width;\n        epY = eventPos.y - this.canvas.height;\n        if('mousedown' == eventType){\n          this.lastTranslateX = st.childs[0].translateX, this.lastTranslateY = st.childs[0].translateY;\n        }\n        if ('mousedrag' == eventType && st.childs.length > 0) {\n          let epDx = eventPos.dx,\n            epDy = eventPos.dy,\n            bound = st.getBound(),\n            w_x_w = this.canvas.width / st.childs[0].scaleX / bound.width,\n            h_y_h = this.canvas.height / st.childs[0].scaleY / bound.height;\n          st.childs[0].translateX = this.lastTranslateX - epDx / w_x_w,\n            st.childs[0].translateY = this.lastTranslateY - epDy / h_y_h;\n        }\n      } else{console.log('other');}\n    }\n  };\n}\n\n/**\n * 创建stage 需要参数canvas\n * 创建一个舞台,需要传递一个canvas对象\n * @param {any} $canvas\n */\nfunction Stage($canvas) {\n  Tobj.stage = this;\n  let _self = this;\n  let isContextMenu = true, isMenuTimeOut = null;\n  /**\n   * 获取事件发生的位置\n   *\n   * @param {any} ev\n   * @returns\n   */\n  function _getEventPosition(ev) {\n    let evPos = Util.getEventPosition(ev),\n      offPos = Util.getOffsetPosition(_self.canvas);\n    return evPos.offsetLeft = evPos.pageX - offPos.left,\n      evPos.offsetTop = evPos.pageY - offPos.top,\n      evPos.x = evPos.offsetLeft,\n      evPos.y = evPos.offsetTop,\n      evPos.target = null,\n      evPos;\n  }\n  function mouseOver(ev) {\n    document.onselectstart = function() {\n      return false;\n    },\n      this.mouseOver = true;\n    let evPos = _getEventPosition(ev);\n    _self.dispatchEventToScenes('mouseover', evPos),\n      _self.dispatchEvent('mouseover', evPos);\n  }\n  function mouseOut(ev) {\n    isMenuTimeOut = setTimeout(function() {\n      isContextMenu = true;\n    },\n      500),\n      document.onselectstart = function() {\n        return true;\n      };\n    let evPos = _getEventPosition(ev);\n    _self.dispatchEventToScenes('mouseout', evPos),\n      _self.dispatchEvent('mouseout', evPos),\n      _self.needRepaint = 0 == _self.animate ? false : true;\n  }\n  function mouseDown(ev) {\n    let evPos = _getEventPosition(ev);\n    _self.mouseDown = true,\n      _self.mouseDownX = evPos.x,\n      _self.mouseDownY = evPos.y,\n      _self.dispatchEventToScenes('mousedown', evPos),\n      _self.dispatchEvent('mousedown', evPos);\n  }\n  function mouseUp(ev) {\n    let evPos = _getEventPosition(ev);\n    _self.dispatchEventToScenes('mouseup', evPos),\n      _self.dispatchEvent('mouseup', evPos),\n      _self.mouseDown = false,\n      _self.needRepaint = 0 == _self.animate ? false : true;\n  }\n  function mouseMove(ev) {\n    isMenuTimeOut && (window.clearTimeout(isMenuTimeOut), isMenuTimeOut = null),\n      isContextMenu = false;\n    let evPos = _getEventPosition(ev);\n    _self.mouseDown ? 0 == ev.button && (evPos.dx = evPos.x - _self.mouseDownX, evPos.dy = evPos.y - _self.mouseDownY, _self.dispatchEventToScenes('mousedrag', evPos), _self.dispatchEvent('mousedrag', evPos), 1 == _self.eagleEye.visible && _self.eagleEye.update()) : (_self.dispatchEventToScenes('mousemove', evPos), _self.dispatchEvent('mousemove', evPos));\n  }\n  function click(ev) {\n    let evPos = _getEventPosition(ev);\n    _self.dispatchEventToScenes('click', evPos),\n      _self.dispatchEvent('click', evPos);\n  }\n  function dbClick(ev) {\n    let evPos = _getEventPosition(ev);\n    _self.dispatchEventToScenes('dbclick', evPos),\n      _self.dispatchEvent('dbclick', evPos);\n  }\n  function mouseWheel(ev) {\n    let evPos = _getEventPosition(ev);\n    _self.dispatchEventToScenes('mousewheel', evPos),\n      _self.dispatchEvent('mousewheel', evPos),\n      null != _self.wheelZoom && (ev.preventDefault ? ev.preventDefault() : (ev = ev || window.event, ev.returnValue = false), 1 == _self.eagleEye.visible && _self.eagleEye.update());\n  }\n  /**\n   * 添加事件\n   *\n   * @param {any} targetDom\n   */\n  function addEvent(targetDom) {\n    if(Util.isIE || !window.addEventListener){\n      targetDom.onmouseout = mouseOut,\n      targetDom.onmouseover = mouseOver,\n      targetDom.onmousedown = mouseDown,\n      targetDom.onmouseup = mouseUp,\n      targetDom.onmousemove = mouseMove,\n      targetDom.onclick = click,\n      targetDom.ondblclick = dbClick,\n      targetDom.onmousewheel = mouseWheel,\n      targetDom.touchstart = mouseDown,\n      targetDom.touchmove = mouseMove,\n      targetDom.touchend = mouseUp;\n    }else{\n      targetDom.addEventListener('mouseout', mouseOut),\n      targetDom.addEventListener('mouseover', mouseOver),\n      targetDom.addEventListener('mousedown', mouseDown),\n      targetDom.addEventListener('mouseup', mouseUp),\n      targetDom.addEventListener('mousemove', mouseMove),\n      targetDom.addEventListener('click', click),\n      targetDom.addEventListener('dblclick', dbClick);\n      if(Util.isFirefox){\n        targetDom.addEventListener('DOMMouseScroll', mouseWheel);\n      }else{\n        targetDom.addEventListener('mousewheel', mouseWheel);\n      }\n    }\n    if(window.addEventListener){\n      window.addEventListener('keydown',\n        function(ev) {\n          _self.dispatchEventToScenes('keydown', Util.cloneEvent(ev));\n          let code = ev.keyCode;\n          if(37 == code || 38 == code || 39 == code || 40 == code){\n            ev.preventDefault ? ev.preventDefault() : (ev = ev || window.event, ev.returnValue = false);\n          }\n        },\n          true);\n    }\n  }\n  this.initialize = function(cans) {\n    addEvent(cans),\n      this.canvas = cans,\n      this.graphics = cans.getContext('2d'),\n      this.childs = [],\n      this.frames = 24,\n      this.messageBus = new Util.MessageBus,\n      this.eagleEye = createEagleEye(this),\n      this.wheelZoom = null,\n      this.mouseDownX = 0,\n      this.mouseDownY = 0,\n      this.mouseDown = false,\n      this.mouseOver = false,\n      this.needRepaint = true,\n      this.serializedProperties = ['frames', 'wheelZoom'];\n  },\n  null != $canvas && this.initialize($canvas);\n  document.oncontextmenu = function() {\n    return isContextMenu;\n  },\n\n  /**\n   * 触发事件\n   * @param {string} eventType 事件类型\n   * @param {any} eventPos 发生事件的位置\n   */\n  this.dispatchEventToScenes = function(eventType, eventPos) {\n    if(0 != this.frames){\n      this.needRepaint = true;\n    }\n    if (1 == this.eagleEye.visible && -1 != eventType.indexOf('mouse')) {\n      let c = eventPos.x,\n        d = eventPos.y;\n      if (c > this.width - this.eagleEye.width && d > this.height - this.eagleEye.height) {\n        return void this.eagleEye.eventHandler(eventType, eventPos, this);\n      }\n    }\n    this.childs.forEach(function(c) {\n      if (1 == c.visible) {\n        let d = c[eventType + 'Handler'];\n        if (null == d) {throw new Error('Function not found:' + eventType + 'Handler');}\n        d.call(c, eventPos);\n      }\n    });\n  },\n  /**\n   * 添加一个stage\n   * @param {any} st stage实例\n   */\n  this.add = function(st) {\n    for (let i = 0; i < this.childs.length; i++){\n      if (this.childs[i] === st) {\n        return;\n      }\n    }\n    st.addTo(this),this.childs.push(st);\n  },\n  /**\n   * 移除一个stage\n   * @param {any} st stage实例\n   */\n  this.remove = function(st) {\n    if (null == st) {throw new Error('Stage.remove出错: 参数为null!');}\n    for (let i = 0; i < this.childs.length; i++) {\n      if (this.childs[i] === st) {\n        st.stage = null,\n        this.childs = this.childs.del(i);\n        return this;\n      }\n    }\n    return this;\n  },\n  /**\n   * 清空所有\n   */\n  this.clear = function() {\n    this.childs = [];\n  },\n  /**\n   * 添加事件\n   * @param {string} evType 事件类型\n   * @param {function} fn 执行函数\n   */\n  this.addEventListener = function(evType, fn) {\n    let _self = this,\n      callback = function(msg) {\n        fn.call(_self, msg);\n      };\n    return this.messageBus.subscribe(evType, callback),\n      this;\n  },\n  this.removeEventListener = function(evType) {\n    this.messageBus.unsubscribe(evType);\n  },\n  this.removeAllEventListener = function() {\n    this.messageBus = new Util.MessageBus;\n  },\n  this.dispatchEvent = function(evType, msg) {\n    return this.messageBus.publish(evType, msg),\n      this;\n  };\n  let events = 'click,dbclick,mousedown,mouseup,mouseover,mouseout,mousemove,mousedrag,mousewheel,touchstart,touchmove,touchend,keydown,keyup'.split(','),\n    tempSelf = this;\n  events.forEach(function(ev) {\n    tempSelf[ev] = function(fn) {\n      null != fn ? this.addEventListener(ev, fn) : this.dispatchEvent(ev);\n    };\n  }),\n  /**\n   * 保存成网页图片(新打开一个页面,用于展示图片)\n   * @param {number} width 区域宽\n   * @param {number} heigh 区域高\n   */\n  this.saveImageInfo = function(width, heigh) {\n    let imgData = this.eagleEye.getImage(width, heigh),\n      newPage = window.open('about:blank');\n    return newPage.document.write('<img src=\\'' + imgData + '\\' alt=\\'from canvas\\'/>'),\n      this;\n  },\n  /**\n   * 保存成本地图片\n   * @param {number} width 区域宽\n   * @param {number} heigh 区域高\n   */\n  this.saveAsLocalImage = function(width, heigh) {\n    let imgData = this.eagleEye.getImage(width, heigh);\n    return imgData.replace('image/png', 'image/octet-stream'),\n      window.location.href = imgData,\n      this;\n  },\n  this.paint = function() {\n    if(null != this.canvas){\n      this.graphics.save();\n      this.graphics.clearRect(0, 0, this.width, this.height);\n      this.childs.forEach(function(item) {\n        1 == item.visible && item.repaint(_self.graphics);\n      });\n      if(1 == this.eagleEye.visible){\n        this.eagleEye.paint(this);\n      }\n      this.graphics.restore();\n    }else{\n      console.log('stage|paint canvas error \"cavas is null\"');\n    }\n    // null != this.canvas &&(this.graphics.save(),this.graphics.clearRect(0, 0, this.width, this.height),\n    // this.childs.forEach(function(a) {1 == a.visible && a.repaint(_self.graphics);\n    // }),1 == this.eagleEye.visible && this.eagleEye.paint(this),this.graphics.restore());\n  },\n  this.repaint = function() {\n    0 != this.frames && (this.frames < 0 && 0 == this.needRepaint || (this.paint(), this.frames < 0 && (this.needRepaint = false)));\n  },\n  this.zoom = function(wheel) {\n    this.childs.forEach(function(st) {\n      0 != st.visible && st.zoom(wheel);\n    });\n  },\n  this.zoomOut = function(wheel) {\n    this.childs.forEach(function(st) {\n      0 != st.visible && st.zoomOut(wheel);\n    });\n  },\n  this.zoomIn = function(wheel) {\n    this.childs.forEach(function(st) {\n      0 != st.visible && st.zoomIn(wheel);\n    });\n  },\n  this.centerAndZoom = function() {\n    this.childs.forEach(function(st) {\n      0 != st.visible && st.centerAndZoom();\n    });\n  },\n  this.setCenter = function(_w, _h) {\n    let _self = this;\n    this.childs.forEach(function(st) {\n      let cw = _w - _self.canvas.width / 2,\n        ch = _h - _self.canvas.height / 2;\n      st.translateX = -cw,\n        st.translateY = -ch;\n    });\n  },\n  this.getBound = function() {\n    let bound = {\n      left: Number.MAX_VALUE,\n      right: Number.MIN_VALUE,\n      top: Number.MAX_VALUE,\n      bottom: Number.MIN_VALUE\n    };\n    return this.childs.forEach(function(st) {\n      let eb = st.getElementsBound();\n      eb.left < bound.left && (bound.left = eb.left, bound.leftNode = eb.leftNode),\n        eb.top < bound.top && (bound.top = eb.top, bound.topNode = eb.topNode),\n        eb.right > bound.right && (bound.right = eb.right, bound.rightNode = eb.rightNode),\n        eb.bottom > bound.bottom && (bound.bottom = eb.bottom, bound.bottomNode = eb.bottomNode);\n    }),\n      bound.width = bound.right - bound.left,\n      bound.height = bound.bottom - bound.top,\n      bound;\n  },\n  /**\n   * 将所有元素转化为json\n   */\n  this.toJson = function() {\n    let _self = this,\n      resultJson = '{\"version\":\"' + Tobj.version + '\",';\n    this.serializedProperties.length;\n    return this.serializedProperties.forEach(function(spItem) {\n      let spItemValue = _self[spItem];\n      'string' == typeof spItemValue && (spItemValue = '\"' + spItemValue + '\"'),\n        resultJson += '\"' + spItem + '\":' + spItemValue + ',';\n    }),\n      resultJson += '\"childs\":[',\n      this.childs.forEach(function(stItem) {\n        resultJson += stItem.toJson();\n      }),\n      resultJson += ']',\n      resultJson += '}';\n  },\n  /**\n   * 匿名自执行函数\n   */\n  function() {\n    0 == _self.frames ?\n    setTimeout(arguments.callee, 100)\n    :\n    _self.frames < 0\n    ?\n    (_self.repaint(), setTimeout(arguments.callee, 1000 / -_self.frames))\n    :\n    (_self.repaint(), setTimeout(arguments.callee, 1000 / _self.frames));\n  } (),\n  /**\n   * 定时器\n   */\n  setTimeout(function() {\n    _self.mousewheel(function(target) {\n      let temp = null == target.wheelDelta ? target.detail : target.wheelDelta;\n      // null != this.wheelZoom && (temp > 0 ? this.zoomIn(this.wheelZoom) : this.zoomOut(this.wheelZoom));\n      // 解决ff 和 chrome兼容性\n      null != this.wheelZoom && (Util.isChrome ? (temp > 0 ? this.zoomOut(this.wheelZoom) : this.zoomIn(this.wheelZoom)) : (temp > 0 ? this.zoomIn(this.wheelZoom) : this.zoomOut(this.wheelZoom)));\n    }),\n      _self.paint();\n  },\n    300),\n  setTimeout(function() {\n    _self.paint();\n  },\n    1e3),\n  setTimeout(function() {\n    _self.paint();\n  },\n    3e3);\n}\n\nStage.prototype = {\n  get width() {\n    return this.canvas.width;\n  },\n  get height() {\n    return this.canvas.height;\n  },\n  set cursor(cur) {\n    this.canvas.style.cursor = cur;\n  },\n  get cursor() {\n    return this.canvas.style.cursor;\n  },\n  set mode(modeType) {\n    this.childs.forEach(function(st) {\n      st.mode = modeType;\n    });\n  }\n};\n\nmodule.exports = Stage;\n"]}